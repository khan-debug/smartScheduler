<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Smart Scheduler{% endblock %}</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Design System & Components -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layouts/sidebar.css') }}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Main App Layout -->
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <a href="/dashboard" class="sidebar-logo" title="Double-click to collapse/expand sidebar">
                    <div class="sidebar-logo-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <span class="sidebar-logo-text">SmartScheduler</span>
                </a>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav">
                {% if session.get('role') == 'admin' %}
                <!-- Admin Navigation -->
                <ul class="sidebar-nav-section">
                    <li class="sidebar-nav-title">Main</li>

                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}" data-tooltip="Dashboard">
                            <span class="nav-icon"><i class="fas fa-th-large"></i></span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                </ul>

                <ul class="sidebar-nav-section">
                    <li class="sidebar-nav-title">Scheduling</li>

                    <li class="nav-item">
                        <a href="/view_timetable" class="nav-link {% if active_page == 'view_timetable' %}active{% endif %}" data-tooltip="View Timetable">
                            <span class="nav-icon"><i class="fas fa-calendar"></i></span>
                            <span class="nav-text">View Timetable</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="/generate" class="nav-link {% if active_page == 'generate' %}active{% endif %}" data-tooltip="Generate">
                            <span class="nav-icon"><i class="fas fa-cogs"></i></span>
                            <span class="nav-text">Generate Schedule</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="/manual_timetable_edit" class="nav-link {% if active_page == 'manual_edit' %}active{% endif %}" data-tooltip="Manual Edit">
                            <span class="nav-icon"><i class="fas fa-edit"></i></span>
                            <span class="nav-text">Manual Edit</span>
                        </a>
                    </li>
                </ul>

                <ul class="sidebar-nav-section">
                    <li class="sidebar-nav-title">Management</li>

                    <li class="nav-item">
                        <a href="/manage_users" class="nav-link {% if active_page == 'users' %}active{% endif %}" data-tooltip="Users">
                            <span class="nav-icon"><i class="fas fa-users"></i></span>
                            <span class="nav-text">Faculty</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="/manage_courses" class="nav-link {% if active_page == 'courses' %}active{% endif %}" data-tooltip="Courses">
                            <span class="nav-icon"><i class="fas fa-book"></i></span>
                            <span class="nav-text">Courses</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="/manage_rooms" class="nav-link {% if active_page == 'rooms' %}active{% endif %}" data-tooltip="Rooms">
                            <span class="nav-icon"><i class="fas fa-door-open"></i></span>
                            <span class="nav-text">Rooms</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="/import_data" class="nav-link {% if active_page == 'import' %}active{% endif %}" data-tooltip="Import Data">
                            <span class="nav-icon"><i class="fas fa-file-import"></i></span>
                            <span class="nav-text">Import Data</span>
                        </a>
                    </li>
                </ul>

                <ul class="sidebar-nav-section">
                    <li class="sidebar-nav-title">Settings</li>

                    <li class="nav-item">
                        <a href="/admin" class="nav-link {% if active_page == 'admin' %}active{% endif %}" data-tooltip="Admin Panel">
                            <span class="nav-icon"><i class="fas fa-cog"></i></span>
                            <span class="nav-text">Admin Panel</span>
                        </a>
                    </li>
                </ul>

                {% else %}
                <!-- Teacher Navigation -->
                <ul class="sidebar-nav-section">
                    <li class="sidebar-nav-title">My Schedule</li>

                    <li class="nav-item">
                        <a href="/teacher" class="nav-link {% if active_page == 'teacher' %}active{% endif %}" data-tooltip="My Timetable">
                            <span class="nav-icon"><i class="fas fa-calendar"></i></span>
                            <span class="nav-text">My Timetable</span>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="/teacher/about" class="nav-link {% if active_page == 'teacher_about' %}active{% endif %}" data-tooltip="My Profile">
                            <span class="nav-icon"><i class="fas fa-user"></i></span>
                            <span class="nav-text">My Profile</span>
                        </a>
                    </li>
                </ul>
                {% endif %}
            </nav>

            <!-- Sidebar Footer (User Profile & Logout) -->
            <div class="sidebar-footer">
                <a href="{% if session.get('role') == 'admin' %}/admin{% else %}/teacher/about{% endif %}" class="sidebar-user" style="margin-bottom: var(--space-3);">
                    <div class="sidebar-user-avatar">
                        {% if session.get('username') %}
                            {{ session.get('username')[0].upper() }}
                        {% else %}
                            ?
                        {% endif %}
                    </div>
                    <div class="sidebar-user-info">
                        <span class="sidebar-user-name">
                            {% if session.get('username') %}
                                {{ session.get('username') }}
                            {% else %}
                                Guest
                            {% endif %}
                        </span>
                        <span class="sidebar-user-role">
                            {% if session.get('role') == 'admin' %}
                                Administrator
                            {% else %}
                                Faculty
                            {% endif %}
                        </span>
                    </div>
                    <i class="fas fa-chevron-right sidebar-user-arrow" style="color: var(--text-tertiary); font-size: var(--text-sm);"></i>
                </a>

                <!-- Logout Button -->
                <a href="/logout" class="nav-link" style="color: var(--error-600); border: 1px solid var(--error-200); background-color: var(--error-50);" data-tooltip="Logout">
                    <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span class="nav-text">Logout</span>
                </a>
            </div>
        </aside>

        <!-- Overlay for mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Mobile Menu Button -->
        <button class="mobile-menu-button" id="mobileMenuButton" aria-label="Open menu">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Global Back Button -->
        <button class="global-back-button" id="globalBackButton" aria-label="Go back" style="display: none;">
            <i class="fas fa-arrow-left"></i>
            <span class="back-text">Back</span>
        </button>

        <!-- Main Content Area -->
        <main class="app-main">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Back Button Styles -->
    <style>
        .global-back-button {
            position: fixed;
            top: var(--space-6);
            right: var(--space-6);
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            padding: var(--space-3) var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            font-weight: var(--weight-semibold);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: calc(var(--z-sticky) + 1);
            transition: all var(--transition-normal);
            opacity: 0;
            transform: translateX(20px);
        }

        .global-back-button.show {
            opacity: 1;
            transform: translateX(0);
            display: flex;
        }

        .global-back-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .global-back-button:active {
            transform: translateY(0);
        }

        .global-back-button i {
            font-size: var(--text-base);
        }

        /* Hide text on smaller screens */
        @media (max-width: 768px) {
            .global-back-button {
                width: 48px;
                height: 48px;
                padding: 0;
                justify-content: center;
                top: var(--space-4);
                right: var(--space-4);
            }

            .global-back-button .back-text {
                display: none;
            }

            .global-back-button i {
                margin: 0;
            }
        }

        /* Adjust position when sidebar is collapsed */
        @media (min-width: 769px) {
            .app-sidebar-collapsed ~ .global-back-button {
                right: var(--space-6);
            }
        }
    </style>

    <!-- Scripts -->
    <script>
        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarLogo = document.querySelector('.sidebar-logo');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mobileMenuButton = document.getElementById('mobileMenuButton');

        // Toggle sidebar collapsed state on double-click of logo
        sidebarLogo?.addEventListener('dblclick', (e) => {
            e.preventDefault(); // Prevent navigation on double-click
            sidebar.classList.toggle('app-sidebar-collapsed');
            // Save preference
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('app-sidebar-collapsed'));
        });

        // Mobile menu
        mobileMenuButton?.addEventListener('click', () => {
            sidebar.classList.add('mobile-open');
            sidebarOverlay.classList.add('active');
        });

        sidebarOverlay?.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
            sidebarOverlay.classList.remove('active');
        });

        // Restore sidebar state from localStorage
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar?.classList.add('app-sidebar-collapsed');
        }

        // Theme Toggle (for future implementation)
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Restore theme from localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Submenu Toggle
        document.querySelectorAll('.nav-link[data-has-submenu]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const parentItem = link.closest('.nav-item');
                parentItem.classList.toggle('expanded');
            });
        });

        // Global Back Button
        const globalBackButton = document.getElementById('globalBackButton');

        // Track navigation depth
        let navigationDepth = 0;
        const dashboardPaths = ['/dashboard', '/teacher'];
        const currentPath = window.location.pathname;

        // Show back button if not on dashboard/main pages
        function updateBackButton() {
            const isDashboard = dashboardPaths.some(path => currentPath === path || currentPath === '/');
            const hasHistory = window.history.length > 1;

            if (!isDashboard && hasHistory) {
                globalBackButton.classList.add('show');
                globalBackButton.style.display = 'flex';
            } else {
                globalBackButton.classList.remove('show');
                setTimeout(() => {
                    if (!globalBackButton.classList.contains('show')) {
                        globalBackButton.style.display = 'none';
                    }
                }, 300);
            }
        }

        // Handle back button click
        globalBackButton?.addEventListener('click', () => {
            // Add a subtle animation
            globalBackButton.style.transform = 'scale(0.95)';
            setTimeout(() => {
                globalBackButton.style.transform = '';
                window.history.back();
            }, 100);
        });

        // Update on page load
        updateBackButton();

        // Update on popstate (browser back/forward)
        window.addEventListener('popstate', updateBackButton);
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
