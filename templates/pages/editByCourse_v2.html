{% extends "layouts/base_v2.html" %}

{% block title %}Edit by Course - Smart Scheduler{% endblock %}

{% block content %}
<div style="padding: var(--space-8); max-width: 1200px; margin: 0 auto;">
    <!-- Page Header -->
    <div style="margin-bottom: var(--space-6);">
        <h1 id="pageTitle" style="margin-bottom: var(--space-2);">Schedule Classes</h1>
        <p id="pageDescription" class="text-secondary">Click on a section code below to schedule that class</p>
    </div>

    <!-- Search Bar -->
    <div class="card card-flat" style="margin-bottom: var(--space-6);">
        <div class="card-body" style="padding: var(--space-4);">
            <div class="form-group" style="margin: 0;">
                <div class="input-icon-left">
                    <i class="fas fa-search"></i>
                    <input
                        type="text"
                        id="searchInput"
                        class="form-input"
                        placeholder="Search courses by name or teacher..."
                        onkeyup="filterCourses()"
                    >
                </div>
            </div>
        </div>
    </div>

    <!-- Courses List -->
    <div id="coursesList">
        <div style="text-align: center; padding: var(--space-8);">
            <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
            <p class="text-secondary">Loading courses...</p>
        </div>
    </div>
</div>

<!-- Scheduling Modal -->
<div id="scheduleModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 600px; box-shadow: var(--shadow-2xl);">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0; position: relative;">
            <span onclick="closeModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; opacity: 0.8; transition: opacity var(--transition-fast);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                &times;
            </span>
            <h2 id="modalTitle" style="margin: 0; color: white; font-size: var(--text-2xl); padding-right: var(--space-8);">Schedule Class</h2>
        </div>

        <!-- Modal Body -->
        <div style="padding: var(--space-8);">
            <!-- Error Message -->
            <div id="errorMessage" style="display: none; background-color: var(--error-100); border: 1px solid var(--error-200); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6); color: var(--error-700);">
                <div style="display: flex; gap: var(--space-3); align-items: start;">
                    <i class="fas fa-exclamation-triangle" style="font-size: var(--text-lg); margin-top: 2px;"></i>
                    <span id="errorText"></span>
                </div>
            </div>

            <!-- Success Message -->
            <div id="successMessage" style="display: none; background-color: var(--success-100); border: 1px solid var(--success-200); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6); color: var(--success-700);">
                <div style="display: flex; gap: var(--space-3); align-items: start;">
                    <i class="fas fa-check-circle" style="font-size: var(--text-lg); margin-top: 2px;"></i>
                    <span id="successText"></span>
                </div>
            </div>

            <!-- Course Details -->
            <div id="courseDetails" class="card card-flat" style="margin-bottom: var(--space-6);">
                <!-- Course details will be inserted here -->
            </div>

            <!-- Schedule Form -->
            <form id="scheduleForm">
                <!-- Day Selection -->
                <div class="form-group">
                    <label class="form-label">Select Day *</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: var(--space-2);">
                        <button type="button" class="day-btn" data-day="Monday" onclick="selectDay('Monday')">Mon</button>
                        <button type="button" class="day-btn" data-day="Tuesday" onclick="selectDay('Tuesday')">Tue</button>
                        <button type="button" class="day-btn" data-day="Wednesday" onclick="selectDay('Wednesday')">Wed</button>
                        <button type="button" class="day-btn" data-day="Thursday" onclick="selectDay('Thursday')">Thu</button>
                        <button type="button" class="day-btn" data-day="Friday" onclick="selectDay('Friday')">Fri</button>
                        <button type="button" class="day-btn" data-day="Saturday" onclick="selectDay('Saturday')">Sat</button>
                        <button type="button" class="day-btn" data-day="Sunday" onclick="selectDay('Sunday')">Sun</button>
                    </div>
                    <input type="hidden" id="selectedDay" required>
                </div>

                <!-- Time Selection -->
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label class="form-label" for="startTime">Start Time *</label>
                        <input type="time" id="startTime" class="form-input" required onchange="calculateEndTime()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">End Time (Auto-calculated)</label>
                        <div id="endTime" style="padding: var(--space-3) var(--space-4); background-color: var(--success-100); border: 1px solid var(--success-200); border-radius: var(--radius-md); color: var(--success-700); font-weight: var(--weight-semibold); min-height: 46px; display: flex; align-items: center;">
                            Select start time first
                        </div>
                    </div>
                </div>

                <!-- Room Selection -->
                <div class="form-group">
                    <label class="form-label" for="roomSelect">Select Room *</label>
                    <select id="roomSelect" class="form-select" required>
                        <option value="">-- Select a Room --</option>
                    </select>
                </div>

                <!-- Submit Button -->
                <button type="button" class="btn btn-primary btn-lg" onclick="scheduleClass()" style="width: 100%;">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Schedule Class</span>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    /* Course Cards */
    .course-card {
        margin-bottom: var(--space-4);
    }

    .course-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: var(--space-3);
    }

    .course-name {
        font-size: var(--text-xl);
        font-weight: var(--weight-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-2);
    }

    .course-info {
        display: flex;
        gap: var(--space-4);
        flex-wrap: wrap;
        color: var(--text-secondary);
        font-size: var(--text-sm);
        margin-bottom: var(--space-4);
    }

    .course-info-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .course-info-item i {
        color: var(--primary-500);
    }

    .sections-container {
        padding-top: var(--space-3);
        border-top: 1px solid var(--border-primary);
    }

    .sections-label {
        font-weight: var(--weight-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-3);
        display: block;
    }

    .sections-grid {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .section-button {
        padding: var(--space-2) var(--space-4);
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        border: none;
        border-radius: var(--radius-md);
        color: white;
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        transition: all var(--transition-fast);
    }

    .section-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    /* Day Buttons */
    .day-btn {
        padding: var(--space-3);
        background-color: var(--bg-secondary);
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        transition: all var(--transition-fast);
        text-align: center;
    }

    .day-btn:hover {
        border-color: var(--primary-400);
        background-color: var(--primary-50);
        color: var(--primary-600);
    }

    .day-btn.selected {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        border-color: var(--primary-500);
        color: white;
    }

    /* Loading Spinner */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-primary);
        border-top-color: var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 640px) {
        .course-info {
            flex-direction: column;
            gap: var(--space-2);
        }
    }
</style>

<script>
    let coursesData = [];
    let currentCourse = null;
    let currentSection = null;
    let selectedDayValue = null;
    let editMode = false;

    window.onload = function() {
        // Check if we're in edit mode
        const urlParams = new URLSearchParams(window.location.search);
        editMode = urlParams.get('edit_mode') === 'true';

        if (editMode) {
            document.getElementById('pageTitle').textContent = 'Edit Scheduled Classes';
            document.getElementById('pageDescription').textContent = 'Click on a section code below to view and edit scheduled classes';
        }

        loadCourses();
        loadRooms();
    };

    function loadCourses() {
        // Use different endpoint based on edit mode
        const endpoint = editMode
            ? '/get_scheduled_courses_with_sections'
            : '/get_all_courses_with_sections';

        console.log('Loading courses from:', endpoint);

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                console.log('Received courses data:', data);
                if (data.success && data.courses) {
                    coursesData = data.courses;
                    displayCourses(coursesData);
                } else {
                    const message = editMode
                        ? 'No scheduled courses found'
                        : 'No courses found';
                    document.getElementById('coursesList').innerHTML = `
                        <div class="card card-flat">
                            <div class="card-body" style="text-align: center; padding: var(--space-8);">
                                <i class="fas fa-inbox" style="font-size: var(--text-5xl); color: var(--text-tertiary); margin-bottom: var(--space-4);"></i>
                                <p class="text-secondary">${message}</p>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('coursesList').innerHTML = `
                    <div class="card card-flat">
                        <div class="card-body" style="text-align: center; padding: var(--space-8);">
                            <i class="fas fa-exclamation-triangle" style="font-size: var(--text-5xl); color: var(--error-500); margin-bottom: var(--space-4);"></i>
                            <p style="color: var(--error-600);">Error loading courses</p>
                        </div>
                    </div>
                `;
            });
    }

    function displayCourses(courses) {
        const coursesList = document.getElementById('coursesList');

        if (courses.length === 0) {
            coursesList.innerHTML = `
                <div class="card card-flat">
                    <div class="card-body" style="text-align: center; padding: var(--space-8);">
                        <i class="fas fa-search" style="font-size: var(--text-5xl); color: var(--text-tertiary); margin-bottom: var(--space-4);"></i>
                        <p class="text-secondary">No courses match your search</p>
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        courses.forEach(course => {
            html += `
                <div class="card card-elevated course-card">
                    <div class="card-body">
                        <div class="course-name">${course.course_name}</div>
                        <div class="course-info">
                            <div class="course-info-item">
                                <i class="fas fa-user-tie"></i>
                                <span>${course.teacher_name}</span>
                            </div>
                            <div class="course-info-item">
                                <i class="fas fa-book"></i>
                                <span>${course.course_type}</span>
                            </div>
                            <div class="course-info-item">
                                <i class="fas fa-clock"></i>
                                <span>${course.credit_hour}h</span>
                            </div>
                            <div class="course-info-item">
                                <i class="fas fa-sun"></i>
                                <span>${course.shift}</span>
                            </div>
                        </div>
                        <div class="sections-container">
                            <span class="sections-label">Sections:</span>
                            <div class="sections-grid">
                                ${course.sections.map(section => `
                                    <button class="section-button" onclick="openScheduleModal('${course._id}', '${section}')">
                                        ${section}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        coursesList.innerHTML = html;
    }

    function filterCourses() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = coursesData.filter(course =>
            course.course_name.toLowerCase().includes(searchTerm) ||
            course.teacher_name.toLowerCase().includes(searchTerm)
        );
        displayCourses(filtered);
    }

    function openScheduleModal(courseId, sectionCode) {
        console.log('Opening modal for:', courseId, sectionCode);

        // If in edit mode, navigate to edit page instead
        if (editMode) {
            window.location.href = `/edit_scheduled_classes?course_id=${courseId}&section_code=${encodeURIComponent(sectionCode)}`;
            return;
        }

        // Find the course
        currentCourse = coursesData.find(c => c._id === courseId);
        currentSection = sectionCode;

        if (!currentCourse) {
            showError('Course not found');
            return;
        }

        // Update modal title and details
        document.getElementById('modalTitle').textContent = `Schedule ${currentCourse.course_name} - ${sectionCode}`;
        document.getElementById('courseDetails').innerHTML = `
            <div class="card-body">
                <h4 style="color: var(--text-primary); margin-bottom: var(--space-2);">${currentCourse.course_name}</h4>
                <div style="color: var(--text-secondary); font-size: var(--text-sm); display: flex; flex-wrap: wrap; gap: var(--space-4);">
                    <span><strong>Section:</strong> ${sectionCode}</span>
                    <span><strong>Teacher:</strong> ${currentCourse.teacher_name}</span>
                    <span><strong>Credit:</strong> ${currentCourse.credit_hour}h</span>
                    <span><strong>Type:</strong> ${currentCourse.course_type}</span>
                </div>
            </div>
        `;

        // Reset form
        document.getElementById('scheduleForm').reset();
        document.getElementById('endTime').textContent = 'Select start time first';
        selectedDayValue = null;

        // Clear day selection
        document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected'));

        // Hide messages
        hideMessages();

        // Show modal
        document.getElementById('scheduleModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('scheduleModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        hideMessages();
    }

    function selectDay(day) {
        selectedDayValue = day;
        document.getElementById('selectedDay').value = day;

        // Update button styles
        document.querySelectorAll('.day-btn').forEach(btn => {
            if (btn.getAttribute('data-day') === day) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });
    }

    function calculateEndTime() {
        const startTime = document.getElementById('startTime').value;

        if (!startTime || !currentCourse) {
            document.getElementById('endTime').textContent = 'Select start time first';
            return;
        }

        const creditHours = currentCourse.credit_hour;
        const [hours, minutes] = startTime.split(':').map(Number);

        const endHours = hours + creditHours;
        const endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        document.getElementById('endTime').textContent = endTime;
    }

    function loadRooms() {
        fetch('/get_all_rooms')
            .then(response => response.json())
            .then(data => {
                const roomSelect = document.getElementById('roomSelect');

                if (data.success && data.rooms && data.rooms.length > 0) {
                    data.rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.room_number;
                        option.textContent = `Room ${room.room_number} (${room.type}) - Floor ${room.floor}`;
                        roomSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
            });
    }

    function scheduleClass() {
        hideMessages();

        // Validate inputs
        if (!selectedDayValue) {
            showError('Please select a day');
            return;
        }

        const startTime = document.getElementById('startTime').value;
        if (!startTime) {
            showError('Please select a start time');
            return;
        }

        const roomNumber = document.getElementById('roomSelect').value;
        if (!roomNumber) {
            showError('Please select a room');
            return;
        }

        if (!currentCourse || !currentSection) {
            showError('Course information missing');
            return;
        }

        // Calculate end time
        const creditHours = currentCourse.credit_hour;
        const [hours, minutes] = startTime.split(':').map(Number);
        const endHours = hours + creditHours;
        const endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        // Prepare data
        const scheduleData = {
            course_id: currentCourse._id,
            section_code: currentSection,
            day: selectedDayValue,
            start_time: startTime,
            end_time: endTime,
            room_number: roomNumber
        };

        console.log('Scheduling with data:', scheduleData);

        // Show loading state
        const submitBtn = event.target;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Scheduling...</span>';
        submitBtn.disabled = true;

        // Send request
        fetch('/schedule_class', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scheduleData)
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            if (data.success) {
                showSuccess('Class scheduled successfully!');
                setTimeout(() => {
                    closeModal();
                }, 1500);
            } else {
                showError(data.message || 'Failed to schedule class');
            }
        })
        .catch(error => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            console.error('Error:', error);
            showError('An error occurred while scheduling the class');
        });
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.style.display = 'block';

        // Scroll to error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        successText.textContent = message;
        successDiv.style.display = 'block';

        // Scroll to success
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('scheduleModal');
        if (event.target == modal) {
            closeModal();
        }
    };

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}
