{% extends "layouts/base.html" %}

{% block title %}Edit Scheduled Classes - Room{% endblock %}

{% block top_bar %}{% endblock %}

{% block content %}
<style>
    .schedule-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
    }

    .room-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
    }

    .room-summary h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
    }

    .room-summary-details {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
        margin-top: 20px;
        opacity: 0.95;
    }

    .summary-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
    }

    .room-badge {
        display: inline-block;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 6px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .scheduled-classes-container {
        background-color: var(--primary-dark);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 40px;
    }

    .section-title {
        color: var(--text-primary);
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-icon {
        color: var(--accent-blue);
        font-size: 1.4rem;
    }

    .classes-grid {
        display: grid;
        gap: 15px;
        margin-bottom: 30px;
    }

    .class-card {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--card-bg) 100%);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .class-card:hover {
        border-color: var(--accent-blue);
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .class-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .class-day {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--accent-blue);
    }

    .class-time {
        font-size: 1rem;
        color: var(--text-primary);
        font-weight: 600;
    }

    .class-course {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
    }

    .class-details {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .class-detail-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .no-classes-message {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .no-classes-message i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .no-classes-message h3 {
        font-size: 1.3rem;
        margin-bottom: 10px;
        color: var(--text-primary);
    }

    .delete-btn {
        background-color: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        color: #ff6b6b;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background-color: rgba(244, 67, 54, 0.2);
        border-color: #ff6b6b;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
    }

    .modal-content {
        background-color: var(--primary-dark);
        margin: 5% auto;
        padding: 0;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px 30px;
        border-radius: 12px 12px 0 0;
    }

    .modal-header h2 {
        margin: 0;
        color: white;
        font-size: 1.5rem;
    }

    .modal-body {
        padding: 30px;
    }

    .close-modal {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.8;
        line-height: 1;
    }

    .close-modal:hover {
        opacity: 1;
    }

    .form-section {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 12px 16px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .day-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
    }

    .day-button {
        padding: 12px 16px;
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .day-button:hover {
        border-color: var(--accent-blue);
    }

    .day-button.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
    }

    .calculated-time {
        background-color: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 8px;
        padding: 12px 16px;
        color: #4caf50;
        font-weight: 600;
        font-size: 1rem;
    }

    .modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .btn-primary {
        flex: 1;
        padding: 14px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        padding: 14px 24px;
        background-color: transparent;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        border-color: var(--accent-blue);
        background-color: var(--card-bg);
    }

    .error-message, .success-message {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.95rem;
        margin-bottom: 20px;
        display: none;
    }

    .error-message {
        background-color: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        color: #ff6b6b;
    }

    .success-message {
        background-color: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        color: #4caf50;
    }
</style>

<button class="back-button" onclick="history.back()">&#8592;</button>

<div class="schedule-container">
    <!-- Room Summary -->
    <div class="room-summary" id="roomSummary">
        <h1 id="roomName">Loading...</h1>
        <div class="room-summary-details">
            <div class="summary-item">
                <i class="fas fa-door-open"></i>
                <span>Room: <span class="room-badge" id="roomNumber">-</span></span>
            </div>
            <div class="summary-item">
                <i class="fas fa-building"></i>
                <span>Floor: <span id="floorNumber">-</span></span>
            </div>
            <div class="summary-item">
                <i class="fas fa-tag"></i>
                <span id="roomType">-</span>
            </div>
        </div>
    </div>

    <!-- Scheduled Classes -->
    <div class="scheduled-classes-container">
        <div class="section-title">
            <i class="fas fa-calendar-alt section-icon"></i>
            Scheduled Classes in This Room
        </div>

        <div id="classesGrid" class="classes-grid">
            <div class="no-classes-message">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>Loading scheduled classes...</h3>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Reschedule Class</h2>
        </div>
        <div class="modal-body">
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <div id="classInfo" style="margin-bottom: 20px; padding: 15px; background-color: var(--card-bg); border-radius: 8px;">
                <!-- Class info will be inserted here -->
            </div>

            <form id="editForm">
                <!-- Day Selection -->
                <div class="form-section">
                    <label class="form-label">Select Day *</label>
                    <div class="day-selector">
                        <div class="day-button" data-day="Monday" onclick="selectDay('Monday')">Mon</div>
                        <div class="day-button" data-day="Tuesday" onclick="selectDay('Tuesday')">Tue</div>
                        <div class="day-button" data-day="Wednesday" onclick="selectDay('Wednesday')">Wed</div>
                        <div class="day-button" data-day="Thursday" onclick="selectDay('Thursday')">Thu</div>
                        <div class="day-button" data-day="Friday" onclick="selectDay('Friday')">Fri</div>
                        <div class="day-button" data-day="Saturday" onclick="selectDay('Saturday')">Sat</div>
                        <div class="day-button" data-day="Sunday" onclick="selectDay('Sunday')">Sun</div>
                    </div>
                    <input type="hidden" id="selectedDay" required>
                </div>

                <!-- Time Selection -->
                <div class="form-section">
                    <label class="form-label">Start Time *</label>
                    <input
                        type="time"
                        id="startTime"
                        class="form-input"
                        required
                        onchange="calculateEndTime()"
                    >
                </div>

                <div class="form-section">
                    <label class="form-label">End Time</label>
                    <div class="calculated-time" id="endTime">
                        <i class="fas fa-calculator"></i> Auto-calculated
                    </div>
                </div>

                <!-- Room Selection -->
                <div class="form-section">
                    <label class="form-label">Select Room *</label>
                    <select id="roomSelect" class="form-select" required>
                        <option value="">-- Select a Room --</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" onclick="updateClass()">
                        <i class="fas fa-save"></i> Update Class
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let roomData = null;
    let scheduledClasses = [];
    let selectedDayValue = null;
    let currentEditingClass = null;

    window.onload = function() {
        loadRoomDetails();
        loadScheduledClasses();
        loadAllRooms();
    };

    function loadRoomDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room_number');

        if (!roomNumber) {
            alert('Invalid room');
            history.back();
            return;
        }

        // Fetch room details
        fetch('/get_all_rooms')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.rooms) {
                    const room = data.rooms.find(r => r.room_number === roomNumber);
                    if (room) {
                        roomData = room;
                        displayRoomDetails(room);
                    } else {
                        alert('Room not found');
                        history.back();
                    }
                } else {
                    alert('Failed to load room details');
                    history.back();
                }
            })
            .catch(error => {
                alert('Error loading room details: ' + error.message);
                history.back();
            });
    }

    function displayRoomDetails(room) {
        document.getElementById('roomName').textContent = `Room ${room.room_number}`;
        document.getElementById('roomNumber').textContent = room.room_number;
        document.getElementById('floorNumber').textContent = room.floor || extractFloor(room.room_number);
        document.getElementById('roomType').textContent = room.type || 'N/A';
    }

    function extractFloor(roomNumber) {
        const roomStr = String(roomNumber);
        if (roomStr.length >= 3) {
            return roomStr.slice(0, -2);
        }
        return 'N/A';
    }

    function loadScheduledClasses() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room_number');

        fetch(`/get_scheduled_classes?room=${encodeURIComponent(roomNumber)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    scheduledClasses = data.classes;
                    displayScheduledClasses(data.classes);
                } else {
                    displayNoClasses('Failed to load scheduled classes');
                }
            })
            .catch(error => {
                displayNoClasses('Error loading scheduled classes');
            });
    }

    function displayScheduledClasses(classes) {
        const grid = document.getElementById('classesGrid');

        if (!classes || classes.length === 0) {
            displayNoClasses('No classes scheduled in this room yet');
            return;
        }

        // Sort by day and time
        const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        classes.sort((a, b) => {
            const dayDiff = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
            if (dayDiff !== 0) return dayDiff;
            return a.start_time.localeCompare(b.start_time);
        });

        let html = '';
        classes.forEach(cls => {
            html += `
                <div class="class-card" onclick="openEditModal('${cls._id}')">
                    <div class="class-card-header">
                        <div>
                            <div class="class-day">${cls.day}</div>
                            <div class="class-time">${cls.start_time} - ${cls.end_time}</div>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteClass('${cls._id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    <div class="class-course">${cls.course_name}</div>
                    <div class="class-details">
                        <div class="class-detail-item">
                            <i class="fas fa-tag"></i>
                            <span>Section: ${cls.section_code}</span>
                        </div>
                        <div class="class-detail-item">
                            <i class="fas fa-user-tie"></i>
                            <span>${cls.teacher_name}</span>
                        </div>
                        <div class="class-detail-item">
                            <i class="fas fa-clock"></i>
                            <span>${cls.credit_hour}h</span>
                        </div>
                        <div class="class-detail-item">
                            <i class="fas fa-book"></i>
                            <span>${cls.course_type}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        grid.innerHTML = html;
    }

    function displayNoClasses(message) {
        const grid = document.getElementById('classesGrid');
        grid.innerHTML = `
            <div class="no-classes-message">
                <i class="fas fa-calendar-times"></i>
                <h3>${message}</h3>
                <p>Click the back button to schedule classes</p>
            </div>
        `;
    }

    function loadAllRooms() {
        fetch('/get_all_rooms')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.rooms) {
                    const roomSelect = document.getElementById('roomSelect');
                    data.rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.room_number;
                        option.textContent = `Room ${room.room_number} (${room.type}, Floor ${room.floor || extractFloor(room.room_number)})`;
                        roomSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
            });
    }

    function openEditModal(classId) {
        const cls = scheduledClasses.find(c => c._id === classId);
        if (!cls) {
            alert('Class not found');
            return;
        }

        currentEditingClass = cls;

        // Display class info
        document.getElementById('classInfo').innerHTML = `
            <strong style="color: var(--text-primary);">${cls.course_name}</strong><br>
            <span style="color: var(--text-secondary);">
                Section: ${cls.section_code} | Teacher: ${cls.teacher_name} |
                Credit: ${cls.credit_hour}h | Type: ${cls.course_type}
            </span>
        `;

        // Set form values
        document.getElementById('startTime').value = cls.start_time;
        document.getElementById('roomSelect').value = cls.room_number;

        // Set selected day
        selectedDayValue = cls.day;
        document.getElementById('selectedDay').value = cls.day;
        document.querySelectorAll('.day-button').forEach(btn => {
            if (btn.dataset.day === cls.day) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });

        // Calculate end time
        calculateEndTime();

        // Clear messages
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';

        // Show modal
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditingClass = null;
        selectedDayValue = null;
        document.getElementById('editForm').reset();
        document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('endTime').innerHTML = '<i class="fas fa-calculator"></i> Auto-calculated';
    }

    function selectDay(day) {
        document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedDayValue = day;
        document.getElementById('selectedDay').value = day;
    }

    function calculateEndTime() {
        const startTime = document.getElementById('startTime').value;
        if (!startTime || !currentEditingClass) return;

        const [hours, minutes] = startTime.split(':').map(Number);
        const creditHours = parseInt(currentEditingClass.credit_hour);

        const endHour = (hours + creditHours) % 24;
        const endTimeStr = `${String(endHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        document.getElementById('endTime').innerHTML = `
            <i class="fas fa-check-circle"></i> ${endTimeStr}
        `;
    }

    function updateClass() {
        if (!currentEditingClass) {
            showError('No class selected');
            return;
        }

        const day = selectedDayValue;
        const startTime = document.getElementById('startTime').value;
        const roomNumber = document.getElementById('roomSelect').value;

        // Validation
        if (!day) {
            showError('Please select a day');
            return;
        }

        if (!startTime) {
            showError('Please select a start time');
            return;
        }

        if (!roomNumber) {
            showError('Please select a room');
            return;
        }

        // Calculate end time
        const [hours, minutes] = startTime.split(':').map(Number);
        const creditHours = parseInt(currentEditingClass.credit_hour);
        const endHour = (hours + creditHours) % 24;
        const endTime = `${String(endHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        // Disable button
        const submitBtn = document.querySelector('.btn-primary');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

        // Send to backend
        fetch(`/update_scheduled_class/${currentEditingClass._id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                day: day,
                start_time: startTime,
                end_time: endTime,
                room_number: roomNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Class';

            if (data.success) {
                showSuccess('Class updated successfully!');
                setTimeout(() => {
                    closeEditModal();
                    loadScheduledClasses();
                }, 1500);
            } else {
                showError(data.error || 'Failed to update class');
            }
        })
        .catch(error => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Class';
            showError('Error updating class: ' + error.message);
        });
    }

    function deleteClass(classId) {
        if (!confirm('Are you sure you want to delete this scheduled class?')) {
            return;
        }

        fetch(`/delete_scheduled_class/${classId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadScheduledClasses();
            } else {
                alert(data.error || 'Failed to delete class');
            }
        })
        .catch(error => {
            alert('Error deleting class: ' + error.message);
        });
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            closeEditModal();
        }
    };
</script>
{% endblock %}
