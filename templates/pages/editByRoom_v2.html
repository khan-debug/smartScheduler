{% extends "layouts/base_v2.html" %}

{% block title %}Edit by Room - Smart Scheduler{% endblock %}

{% block content %}
<div style="padding: var(--space-8); max-width: 1200px; margin: 0 auto;">
    <!-- Page Header -->
    <div style="margin-bottom: var(--space-6);">
        <h1 id="pageTitle" style="margin-bottom: var(--space-2);">Schedule Classes by Room</h1>
        <p id="pageDescription" class="text-secondary">First select a floor, then choose a room to schedule a class</p>
    </div>

    <!-- Floor Selection Section -->
    <div id="floorSelection" class="card card-elevated" style="margin-bottom: var(--space-6);">
        <div class="card-header">
            <h3 class="card-title">Step 1: Select a Floor</h3>
        </div>
        <div class="card-body">
            <div class="form-group" style="margin: 0;">
                <select id="floorSelect" class="form-select" onchange="onFloorSelected()">
                    <option value="">-- Select a Floor --</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Rooms Section (hidden until floor is selected) -->
    <div id="roomsSection" style="display: none;">
        <div style="margin-bottom: var(--space-6);">
            <h3 style="margin-bottom: var(--space-2);">
                Step 2: Select a Room on Floor <span id="selectedFloorLabel" style="color: var(--primary-500);"></span>
            </h3>
            <p class="text-secondary">Click on a room to schedule a class</p>
        </div>

        <!-- Search Bar -->
        <div class="card card-flat" style="margin-bottom: var(--space-6);">
            <div class="card-body" style="padding: var(--space-4);">
                <div class="form-group" style="margin: 0;">
                    <div class="input-icon-left">
                        <i class="fas fa-search"></i>
                        <input
                            type="text"
                            id="searchInput"
                            class="form-input"
                            placeholder="Search rooms by number or type..."
                            onkeyup="filterRooms()"
                        >
                    </div>
                </div>
            </div>
        </div>

        <!-- Rooms List -->
        <div id="roomsList">
            <div style="text-align: center; padding: var(--space-8);">
                <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
                <p class="text-secondary">Loading rooms...</p>
            </div>
        </div>
    </div>
</div>

<!-- Scheduling Modal -->
<div id="scheduleModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 3% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 700px; box-shadow: var(--shadow-2xl); max-height: 90vh; overflow-y: auto;">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0; position: sticky; top: 0; z-index: 1;">
            <span onclick="closeModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; opacity: 0.8; transition: opacity var(--transition-fast);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                &times;
            </span>
            <h2 id="modalTitle" style="margin: 0; color: white; font-size: var(--text-2xl); padding-right: var(--space-8);">Schedule Class</h2>
        </div>

        <!-- Modal Body -->
        <div style="padding: var(--space-8);">
            <!-- Error Message -->
            <div id="errorMessage" style="display: none; background-color: var(--error-100); border: 1px solid var(--error-200); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6); color: var(--error-700);">
                <div style="display: flex; gap: var(--space-3); align-items: start;">
                    <i class="fas fa-exclamation-triangle" style="font-size: var(--text-lg); margin-top: 2px;"></i>
                    <span id="errorText"></span>
                </div>
            </div>

            <!-- Success Message -->
            <div id="successMessage" style="display: none; background-color: var(--success-100); border: 1px solid var(--success-200); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6); color: var(--success-700);">
                <div style="display: flex; gap: var(--space-3); align-items: start;">
                    <i class="fas fa-check-circle" style="font-size: var(--text-lg); margin-top: 2px;"></i>
                    <span id="successText"></span>
                </div>
            </div>

            <!-- Room Details -->
            <div id="roomDetails" class="card card-flat" style="margin-bottom: var(--space-6);">
                <!-- Room details will be inserted here -->
            </div>

            <!-- Schedule Form -->
            <form id="scheduleForm">
                <!-- Shift Selection -->
                <div class="form-group">
                    <label class="form-label">Select Shift *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                        <button type="button" class="shift-btn" data-shift="Morning" onclick="selectShift('Morning')">
                            <i class="fas fa-sun"></i> Morning
                        </button>
                        <button type="button" class="shift-btn" data-shift="Evening" onclick="selectShift('Evening')">
                            <i class="fas fa-moon"></i> Evening
                        </button>
                    </div>
                    <input type="hidden" id="selectedShift" required>
                </div>

                <!-- Course Selection -->
                <div class="form-group">
                    <label class="form-label" for="courseSelect">Select Course *</label>
                    <select id="courseSelect" class="form-select" onchange="loadSections()" required>
                        <option value="">-- Select Shift First --</option>
                    </select>
                </div>

                <!-- Section Selection -->
                <div class="form-group">
                    <label class="form-label" for="sectionSelect">Select Section *</label>
                    <select id="sectionSelect" class="form-select" required>
                        <option value="">-- Select Course First --</option>
                    </select>
                </div>

                <!-- Day Selection -->
                <div class="form-group">
                    <label class="form-label">Select Day *</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: var(--space-2);">
                        <button type="button" class="day-btn" data-day="Monday" onclick="selectDay('Monday')">Mon</button>
                        <button type="button" class="day-btn" data-day="Tuesday" onclick="selectDay('Tuesday')">Tue</button>
                        <button type="button" class="day-btn" data-day="Wednesday" onclick="selectDay('Wednesday')">Wed</button>
                        <button type="button" class="day-btn" data-day="Thursday" onclick="selectDay('Thursday')">Thu</button>
                        <button type="button" class="day-btn" data-day="Friday" onclick="selectDay('Friday')">Fri</button>
                        <button type="button" class="day-btn" data-day="Saturday" onclick="selectDay('Saturday')">Sat</button>
                        <button type="button" class="day-btn" data-day="Sunday" onclick="selectDay('Sunday')">Sun</button>
                    </div>
                    <input type="hidden" id="selectedDay" required>
                </div>

                <!-- Time Selection -->
                <div class="form-grid form-grid-2">
                    <div class="form-group">
                        <label class="form-label" for="startTime">Start Time *</label>
                        <input type="time" id="startTime" class="form-input" required onchange="calculateEndTime()">
                        <div class="form-help">
                            <span id="timeConstraint">Select a course to see time restrictions</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">End Time (Auto-calculated)</label>
                        <div id="endTime" style="padding: var(--space-3) var(--space-4); background-color: var(--success-100); border: 1px solid var(--success-200); border-radius: var(--radius-md); color: var(--success-700); font-weight: var(--weight-semibold); min-height: 46px; display: flex; align-items: center;">
                            Select start time first
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="button" class="btn btn-primary btn-lg" onclick="scheduleClass()" style="width: 100%;">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Schedule Class</span>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    /* Room Cards */
    .room-card {
        margin-bottom: var(--space-4);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .room-card:hover {
        transform: translateX(4px);
    }

    .room-number {
        font-size: var(--text-xl);
        font-weight: var(--weight-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-2);
    }

    .room-info {
        display: flex;
        gap: var(--space-4);
        flex-wrap: wrap;
        color: var(--text-secondary);
        font-size: var(--text-sm);
    }

    .room-info-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .room-info-item i {
        color: var(--primary-500);
    }

    /* Shift Buttons */
    .shift-btn {
        padding: var(--space-4);
        background-color: var(--bg-secondary);
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: var(--text-base);
        font-weight: var(--weight-medium);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
    }

    .shift-btn:hover {
        border-color: var(--primary-400);
        background-color: var(--primary-50);
        color: var(--primary-600);
    }

    .shift-btn.selected {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        border-color: var(--primary-500);
        color: white;
    }

    /* Day Buttons */
    .day-btn {
        padding: var(--space-3);
        background-color: var(--bg-secondary);
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        transition: all var(--transition-fast);
        text-align: center;
    }

    .day-btn:hover {
        border-color: var(--primary-400);
        background-color: var(--primary-50);
        color: var(--primary-600);
    }

    .day-btn.selected {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        border-color: var(--primary-500);
        color: white;
    }

    /* Loading Spinner */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-primary);
        border-top-color: var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 640px) {
        .room-info {
            flex-direction: column;
            gap: var(--space-2);
        }
    }
</style>

<script>
    let roomsData = [];
    let currentRoom = null;
    let coursesData = [];
    let selectedShiftValue = null;
    let selectedDayValue = null;
    let currentCourse = null;
    let currentSection = null;
    let editMode = false;

    window.onload = function() {
        // Check if we're in edit mode
        const urlParams = new URLSearchParams(window.location.search);
        editMode = urlParams.get('edit_mode') === 'true';

        if (editMode) {
            document.getElementById('pageTitle').textContent = 'Edit Scheduled Classes by Room';
            document.getElementById('pageDescription').textContent = 'Select a floor and room to view and edit scheduled classes';
        }

        loadFloors();
    };

    function loadFloors() {
        fetch('/get_floors')
            .then(response => response.json())
            .then(data => {
                const floorSelect = document.getElementById('floorSelect');

                if (data.floors && data.floors.length > 0) {
                    data.floors.forEach(floor => {
                        const option = document.createElement('option');
                        option.value = floor.floor;
                        option.textContent = `Floor ${floor.floor} (${floor.count} room${floor.count !== 1 ? 's' : ''})`;
                        floorSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading floors:', error);
            });
    }

    function onFloorSelected() {
        const floorNumber = document.getElementById('floorSelect').value;

        if (!floorNumber) {
            document.getElementById('roomsSection').style.display = 'none';
            return;
        }

        document.getElementById('selectedFloorLabel').textContent = floorNumber;
        document.getElementById('roomsSection').style.display = 'block';
        loadRooms(floorNumber);
    }

    function loadRooms(floorNumber) {
        // Use different endpoint based on edit mode
        const endpoint = editMode
            ? `/get_rooms_with_classes_by_floor/${floorNumber}`
            : `/get_rooms_by_floor/${floorNumber}`;

        console.log('Loading rooms from:', endpoint);

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                console.log('Received rooms data:', data);
                if (data.items && data.items.length > 0) {
                    roomsData = data.items;
                    displayRooms(roomsData);
                } else {
                    const message = editMode
                        ? 'No rooms with scheduled classes found on this floor'
                        : 'No rooms found on this floor';
                    document.getElementById('roomsList').innerHTML = `
                        <div class="card card-flat">
                            <div class="card-body" style="text-align: center; padding: var(--space-8);">
                                <i class="fas fa-inbox" style="font-size: var(--text-5xl); color: var(--text-tertiary); margin-bottom: var(--space-4);"></i>
                                <p class="text-secondary">${message}</p>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
                document.getElementById('roomsList').innerHTML = `
                    <div class="card card-flat">
                        <div class="card-body" style="text-align: center; padding: var(--space-8);">
                            <i class="fas fa-exclamation-triangle" style="font-size: var(--text-5xl); color: var(--error-500); margin-bottom: var(--space-4);"></i>
                            <p style="color: var(--error-600);">Error loading rooms</p>
                        </div>
                    </div>
                `;
            });
    }

    function displayRooms(rooms) {
        const roomsList = document.getElementById('roomsList');

        if (rooms.length === 0) {
            roomsList.innerHTML = `
                <div class="card card-flat">
                    <div class="card-body" style="text-align: center; padding: var(--space-8);">
                        <i class="fas fa-search" style="font-size: var(--text-5xl); color: var(--text-tertiary); margin-bottom: var(--space-4);"></i>
                        <p class="text-secondary">No rooms match your search</p>
                    </div>
                </div>
            `;
            return;
        }

        let html = '';
        rooms.forEach(room => {
            const scheduledCount = room.scheduled_classes_count || 0;
            const countBadge = scheduledCount > 0
                ? `<div class="room-info-item" style="color: var(--primary-600); font-weight: var(--weight-semibold);">
                       <i class="fas fa-calendar-check"></i>
                       <span>${scheduledCount} class${scheduledCount !== 1 ? 'es' : ''} scheduled</span>
                   </div>`
                : `<div class="room-info-item" style="color: var(--text-tertiary);">
                       <i class="fas fa-calendar"></i>
                       <span>No classes scheduled</span>
                   </div>`;

            html += `
                <div class="card card-elevated room-card" onclick="selectRoom('${room.room_number}', '${room.type}', '${room.floor_number}')">
                    <div class="card-body">
                        <div class="room-number">Room ${room.room_number}</div>
                        <div class="room-info">
                            <div class="room-info-item">
                                <i class="fas fa-door-open"></i>
                                <span>${room.type}</span>
                            </div>
                            ${countBadge}
                        </div>
                    </div>
                </div>
            `;
        });

        roomsList.innerHTML = html;
    }

    function filterRooms() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = roomsData.filter(room =>
            room.room_number.toLowerCase().includes(searchTerm) ||
            room.type.toLowerCase().includes(searchTerm)
        );
        displayRooms(filtered);
    }

    function selectRoom(roomNumber, roomType, floor) {
        console.log('Selected room:', roomNumber);

        // If in edit mode, navigate to edit page
        if (editMode) {
            window.location.href = `/edit_scheduled_classes_by_room?room_number=${encodeURIComponent(roomNumber)}`;
            return;
        }

        currentRoom = { room_number: roomNumber, type: roomType, floor: floor };

        // Update modal
        document.getElementById('modalTitle').textContent = `Schedule Class in Room ${roomNumber}`;
        document.getElementById('roomDetails').innerHTML = `
            <div class="card-body">
                <h4 style="color: var(--text-primary); margin-bottom: var(--space-2);">Room ${roomNumber}</h4>
                <div style="color: var(--text-secondary); font-size: var(--text-sm); display: flex; flex-wrap: wrap; gap: var(--space-4);">
                    <span><strong>Type:</strong> ${roomType}</span>
                    <span><strong>Floor:</strong> ${floor}</span>
                </div>
            </div>
        `;

        // Reset form
        resetForm();

        // Show modal
        document.getElementById('scheduleModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('scheduleModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        hideMessages();
    }

    function resetForm() {
        document.getElementById('scheduleForm').reset();
        selectedShiftValue = null;
        selectedDayValue = null;
        currentCourse = null;
        currentSection = null;

        document.querySelectorAll('.shift-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected'));

        document.getElementById('courseSelect').innerHTML = '<option value="">-- Select Shift First --</option>';
        document.getElementById('sectionSelect').innerHTML = '<option value="">-- Select Course First --</option>';
        document.getElementById('endTime').textContent = 'Select start time first';
        document.getElementById('timeConstraint').textContent = 'Select a course to see time restrictions';

        hideMessages();
    }

    function selectShift(shift) {
        selectedShiftValue = shift;
        document.getElementById('selectedShift').value = shift;

        // Update button styles
        document.querySelectorAll('.shift-btn').forEach(btn => {
            if (btn.getAttribute('data-shift') === shift) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });

        // Load courses for this shift
        loadCourses(shift);
    }

    function loadCourses(shift) {
        fetch(`/get_courses_by_shift/${shift}`)
            .then(response => response.json())
            .then(data => {
                const courseSelect = document.getElementById('courseSelect');
                courseSelect.innerHTML = '<option value="">-- Select a Course --</option>';

                if (data.success && data.courses && data.courses.length > 0) {
                    coursesData = data.courses;
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course._id;
                        option.textContent = `${course.course_name} (${course.teacher_name})`;
                        courseSelect.appendChild(option);
                    });
                } else {
                    courseSelect.innerHTML = '<option value="">No courses available for this shift</option>';
                }
            })
            .catch(error => {
                console.error('Error loading courses:', error);
            });
    }

    function loadSections() {
        const courseId = document.getElementById('courseSelect').value;
        const sectionSelect = document.getElementById('sectionSelect');

        if (!courseId) {
            sectionSelect.innerHTML = '<option value="">-- Select Course First --</option>';
            currentCourse = null;
            return;
        }

        currentCourse = coursesData.find(c => c._id === courseId);

        if (currentCourse && currentCourse.sections) {
            sectionSelect.innerHTML = '<option value="">-- Select a Section --</option>';
            currentCourse.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });

            // Update time constraint info
            document.getElementById('timeConstraint').textContent = `Course duration: ${currentCourse.credit_hour} hour${currentCourse.credit_hour !== 1 ? 's' : ''}`;
        }
    }

    function selectDay(day) {
        selectedDayValue = day;
        document.getElementById('selectedDay').value = day;

        // Update button styles
        document.querySelectorAll('.day-btn').forEach(btn => {
            if (btn.getAttribute('data-day') === day) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });
    }

    function calculateEndTime() {
        const startTime = document.getElementById('startTime').value;

        if (!startTime || !currentCourse) {
            document.getElementById('endTime').textContent = 'Select start time first';
            return;
        }

        const creditHours = currentCourse.credit_hour;
        const [hours, minutes] = startTime.split(':').map(Number);

        const endHours = hours + creditHours;
        const endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        document.getElementById('endTime').textContent = endTime;
    }

    function scheduleClass() {
        hideMessages();

        // Validate inputs
        if (!selectedShiftValue) {
            showError('Please select a shift');
            return;
        }

        const courseId = document.getElementById('courseSelect').value;
        if (!courseId) {
            showError('Please select a course');
            return;
        }

        const sectionCode = document.getElementById('sectionSelect').value;
        if (!sectionCode) {
            showError('Please select a section');
            return;
        }

        if (!selectedDayValue) {
            showError('Please select a day');
            return;
        }

        const startTime = document.getElementById('startTime').value;
        if (!startTime) {
            showError('Please select a start time');
            return;
        }

        if (!currentRoom) {
            showError('Room information missing');
            return;
        }

        // Calculate end time
        const creditHours = currentCourse.credit_hour;
        const [hours, minutes] = startTime.split(':').map(Number);
        const endHours = hours + creditHours;
        const endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        // Prepare data
        const scheduleData = {
            course_id: courseId,
            section_code: sectionCode,
            day: selectedDayValue,
            start_time: startTime,
            end_time: endTime,
            room_number: currentRoom.room_number
        };

        console.log('Scheduling with data:', scheduleData);

        // Show loading state
        const submitBtn = event.target;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Scheduling...</span>';
        submitBtn.disabled = true;

        // Send request
        fetch('/schedule_class', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scheduleData)
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            if (data.success) {
                showSuccess('Class scheduled successfully!');
                setTimeout(() => {
                    closeModal();
                }, 1500);
            } else {
                showError(data.message || 'Failed to schedule class');
            }
        })
        .catch(error => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            console.error('Error:', error);
            showError('An error occurred while scheduling the class');
        });
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        successText.textContent = message;
        successDiv.style.display = 'block';
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('scheduleModal');
        if (event.target == modal) {
            closeModal();
        }
    };

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}
