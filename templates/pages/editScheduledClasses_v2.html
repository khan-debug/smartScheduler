{% extends "layouts/base_v2.html" %}

{% block title %}Edit Scheduled Classes{% endblock %}

{% block content %}
<div style="padding: var(--space-8); max-width: 1400px; margin: 0 auto;">
    <!-- Course Summary Header -->
    <div class="card card-elevated" style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); border: none; margin-bottom: var(--space-8);">
        <div class="card-body" style="padding: var(--space-8);">
            <h1 id="courseName" style="color: white; margin-bottom: var(--space-4); font-size: var(--text-3xl);">
                Loading...
            </h1>
            <div style="display: flex; gap: var(--space-6); flex-wrap: wrap; opacity: 0.95;">
                <div style="display: flex; align-items: center; gap: var(--space-2); color: white;">
                    <i class="fas fa-tag"></i>
                    <span>Section: <span id="sectionCode" style="background: rgba(255,255,255,0.2); padding: var(--space-1) var(--space-3); border-radius: var(--radius-full); font-weight: var(--weight-semibold); margin-left: var(--space-2);">-</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-2); color: white;">
                    <i class="fas fa-user-tie"></i>
                    <span id="teacherName">-</span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-2); color: white;">
                    <i class="fas fa-clock"></i>
                    <span><span id="creditHour">-</span> Credit Hour(s)</span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-2); color: white;">
                    <i class="fas fa-book"></i>
                    <span id="courseType">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduled Classes Section -->
    <div class="card card-elevated">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-calendar-alt"></i> Scheduled Classes
            </h3>
        </div>
        <div class="card-body">
            <div id="classesGrid" style="display: grid; gap: var(--space-4);">
                <!-- Loading state -->
                <div style="text-align: center; padding: var(--space-12);">
                    <div class="spinner" style="width: 40px; height: 40px; border: 4px solid var(--border-primary); border-top-color: var(--primary-500); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto var(--space-4);"></div>
                    <p class="text-secondary">Loading scheduled classes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-2xl); width: 90%; max-width: 600px; box-shadow: var(--shadow-2xl);">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); padding: var(--space-8); border-radius: var(--radius-2xl) var(--radius-2xl) 0 0; position: relative;">
            <span onclick="closeEditModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background var(--transition-fast);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                &times;
            </span>
            <h2 style="margin: 0; color: white; font-size: var(--text-2xl);">Reschedule Class</h2>
        </div>

        <!-- Modal Body -->
        <div style="padding: var(--space-8);">
            <div id="errorMessage" style="display: none; background-color: var(--error-100); border: 1px solid var(--error-200); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4); color: var(--error-700);"></div>
            <div id="successMessage" style="display: none; background-color: var(--success-100); border: 1px solid var(--success-200); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4); color: var(--success-700);"></div>

            <form id="editForm">
                <!-- Day Selection -->
                <div class="form-group">
                    <label class="form-label">Select Day *</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: var(--space-2);">
                        <div class="day-button" data-day="Monday" onclick="selectDay('Monday')">Mon</div>
                        <div class="day-button" data-day="Tuesday" onclick="selectDay('Tuesday')">Tue</div>
                        <div class="day-button" data-day="Wednesday" onclick="selectDay('Wednesday')">Wed</div>
                        <div class="day-button" data-day="Thursday" onclick="selectDay('Thursday')">Thu</div>
                        <div class="day-button" data-day="Friday" onclick="selectDay('Friday')">Fri</div>
                        <div class="day-button" data-day="Saturday" onclick="selectDay('Saturday')">Sat</div>
                        <div class="day-button" data-day="Sunday" onclick="selectDay('Sunday')">Sun</div>
                    </div>
                    <input type="hidden" id="selectedDay" required>
                </div>

                <!-- Time Selection -->
                <div class="form-group">
                    <label class="form-label" for="startTime">Start Time *</label>
                    <input type="time" id="startTime" class="form-input" required onchange="calculateEndTime()">
                </div>

                <div class="form-group">
                    <label class="form-label">End Time</label>
                    <div id="endTime" style="background-color: var(--success-100); border: 1px solid var(--success-200); border-radius: var(--radius-md); padding: var(--space-4); color: var(--success-700); font-weight: var(--weight-semibold);">
                        <i class="fas fa-calculator"></i> Auto-calculated
                    </div>
                </div>

                <!-- Room Selection -->
                <div class="form-group">
                    <label class="form-label" for="roomSelect">Select Room *</label>
                    <select id="roomSelect" class="form-select" required>
                        <option value="">-- Select a Room --</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--space-3); margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--border-primary);">
                    <button type="button" class="btn btn-secondary btn-lg" onclick="closeEditModal()" style="flex: 1;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="updateClass()" style="flex: 1;">
                        <i class="fas fa-save"></i> <span>Update Class</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Class Cards */
    .class-card {
        background: var(--bg-elevated);
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        cursor: pointer;
        transition: all var(--transition-normal);
    }

    .class-card:hover {
        border-color: var(--primary-500);
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    /* Day Buttons */
    .day-button {
        padding: var(--space-3) var(--space-4);
        background-color: var(--bg-secondary);
        border: 2px solid var(--border-primary);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-weight: var(--weight-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: center;
        font-size: var(--text-sm);
    }

    .day-button:hover {
        border-color: var(--primary-500);
        background-color: var(--primary-50);
    }

    .day-button.selected {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        border-color: var(--primary-500);
        color: white;
    }

    /* Spinner Animation */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<script>
    let courseData = null;
    let scheduledClasses = [];
    let selectedDayValue = null;
    let currentEditingClass = null;

    window.onload = function() {
        loadCourseDetails();
        loadScheduledClasses();
        loadRooms();
    };

    function loadCourseDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course_id');
        const sectionCode = urlParams.get('section_code');

        if (!courseId || !sectionCode) {
            alert('Invalid course or section');
            history.back();
            return;
        }

        fetch(`/get_course_details?course_id=${courseId}&section_code=${encodeURIComponent(sectionCode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    courseData = data.course;
                    displayCourseDetails(data.course, sectionCode);
                } else {
                    alert(data.error || 'Failed to load course details');
                    history.back();
                }
            })
            .catch(error => {
                alert('Error loading course details: ' + error.message);
                history.back();
            });
    }

    function displayCourseDetails(course, section) {
        document.getElementById('courseName').textContent = course.course_name;
        document.getElementById('sectionCode').textContent = section;
        document.getElementById('teacherName').textContent = course.teacher_name;
        document.getElementById('creditHour').textContent = course.credit_hour;
        document.getElementById('courseType').textContent = course.course_type;
    }

    function loadScheduledClasses() {
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course_id');
        const sectionCode = urlParams.get('section_code');

        fetch(`/get_scheduled_classes_by_course?course_id=${courseId}&section_code=${encodeURIComponent(sectionCode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    scheduledClasses = data.classes;
                    displayScheduledClasses(data.classes);
                } else {
                    displayNoClasses('Failed to load scheduled classes');
                }
            })
            .catch(error => {
                displayNoClasses('Error loading scheduled classes');
            });
    }

    function displayScheduledClasses(classes) {
        const grid = document.getElementById('classesGrid');

        if (!classes || classes.length === 0) {
            displayNoClasses('No classes scheduled yet');
            return;
        }

        // Sort by day and time
        const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        classes.sort((a, b) => {
            const dayDiff = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
            if (dayDiff !== 0) return dayDiff;
            return a.start_time.localeCompare(b.start_time);
        });

        let html = '';
        classes.forEach(cls => {
            html += `
                <div class="class-card" onclick="openEditModal('${cls._id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                        <div>
                            <div style="font-size: var(--text-xl); font-weight: var(--weight-bold); color: var(--primary-600); margin-bottom: var(--space-1);">${cls.day}</div>
                            <div style="font-size: var(--text-lg); color: var(--text-primary); font-weight: var(--weight-semibold);">${cls.start_time} - ${cls.end_time}</div>
                        </div>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteClass('${cls._id}')" style="padding: var(--space-2) var(--space-3);">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    <div style="display: flex; gap: var(--space-4); flex-wrap: wrap; color: var(--text-secondary); font-size: var(--text-sm);">
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <i class="fas fa-door-open"></i>
                            <span>Room ${cls.room_number}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <i class="fas fa-building"></i>
                            <span>Floor ${cls.floor}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <i class="fas fa-clock"></i>
                            <span>${cls.credit_hour}h</span>
                        </div>
                    </div>
                </div>
            `;
        });

        grid.innerHTML = html;
    }

    function displayNoClasses(message) {
        const grid = document.getElementById('classesGrid');
        grid.innerHTML = `
            <div style="text-align: center; padding: var(--space-12); background-color: var(--bg-secondary); border: 2px dashed var(--border-primary); border-radius: var(--radius-xl);">
                <div style="font-size: var(--text-6xl); margin-bottom: var(--space-4); opacity: 0.3;">ðŸ“…</div>
                <h3 style="color: var(--text-primary); margin-bottom: var(--space-2);">${message}</h3>
                <p class="text-secondary">Click the back button to schedule classes</p>
            </div>
        `;
    }

    function loadRooms() {
        fetch('/get_all_rooms')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.rooms) {
                    const roomSelect = document.getElementById('roomSelect');
                    data.rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.room_number;
                        option.textContent = `Room ${room.room_number} (${room.type}, Floor ${room.floor})`;
                        roomSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading rooms:', error);
            });
    }

    function openEditModal(classId) {
        const cls = scheduledClasses.find(c => c._id === classId);
        if (!cls) {
            alert('Class not found');
            return;
        }

        currentEditingClass = cls;

        // Set form values
        document.getElementById('startTime').value = cls.start_time;
        document.getElementById('roomSelect').value = cls.room_number;

        // Set selected day
        selectedDayValue = cls.day;
        document.getElementById('selectedDay').value = cls.day;
        document.querySelectorAll('.day-button').forEach(btn => {
            if (btn.dataset.day === cls.day) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        });

        // Calculate end time
        calculateEndTime();

        // Clear messages
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';

        // Show modal
        document.getElementById('editModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        currentEditingClass = null;
        selectedDayValue = null;
        document.getElementById('editForm').reset();
        document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('endTime').innerHTML = '<i class="fas fa-calculator"></i> Auto-calculated';
    }

    function selectDay(day) {
        document.querySelectorAll('.day-button').forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        selectedDayValue = day;
        document.getElementById('selectedDay').value = day;
    }

    function calculateEndTime() {
        const startTime = document.getElementById('startTime').value;
        if (!startTime || !courseData) return;

        const [hours, minutes] = startTime.split(':').map(Number);
        const creditHours = parseInt(courseData.credit_hour);

        const endHour = (hours + creditHours) % 24;
        const endTimeStr = `${String(endHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        document.getElementById('endTime').innerHTML = `
            <i class="fas fa-check-circle"></i> ${endTimeStr}
        `;
    }

    function updateClass() {
        if (!currentEditingClass) {
            showError('No class selected');
            return;
        }

        const day = selectedDayValue;
        const startTime = document.getElementById('startTime').value;
        const roomNumber = document.getElementById('roomSelect').value;

        // Validation
        if (!day) {
            showError('Please select a day');
            return;
        }

        if (!startTime) {
            showError('Please select a start time');
            return;
        }

        if (!roomNumber) {
            showError('Please select a room');
            return;
        }

        // Calculate end time
        const [hours, minutes] = startTime.split(':').map(Number);
        const creditHours = parseInt(courseData.credit_hour);
        const endHour = (hours + creditHours) % 24;
        const endTime = `${String(endHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        // Disable button
        const submitBtn = event.target.closest('button');
        const originalHTML = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Updating...</span>';

        // Send to backend
        fetch(`/update_scheduled_class/${currentEditingClass._id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                day: day,
                start_time: startTime,
                end_time: endTime,
                room_number: roomNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHTML;

            if (data.success) {
                showSuccess('Class updated successfully!');
                setTimeout(() => {
                    closeEditModal();
                    loadScheduledClasses();
                }, 1500);
            } else {
                showError(data.error || 'Failed to update class');
            }
        })
        .catch(error => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHTML;
            showError('Error updating class: ' + error.message);
        });
    }

    function deleteClass(classId) {
        if (!confirm('Are you sure you want to delete this scheduled class?')) {
            return;
        }

        fetch(`/delete_scheduled_class/${classId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success toast
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: var(--space-6); right: var(--space-6); background-color: var(--success-100); border: 1px solid var(--success-200); color: var(--success-700); padding: var(--space-4); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 9999;';
                toast.innerHTML = '<i class="fas fa-check-circle"></i> Class deleted successfully';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);

                loadScheduledClasses();
            } else {
                alert(data.error || 'Failed to delete class');
            }
        })
        .catch(error => {
            alert('Error deleting class: ' + error.message);
        });
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            closeEditModal();
        }
    };

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeEditModal();
        }
    });
</script>
{% endblock %}
