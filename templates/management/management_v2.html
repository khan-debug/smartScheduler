{% extends "layouts/base_v2.html" %}

{% block title %}{{ header_title }}{% endblock %}

{% block content %}
<div style="padding: var(--space-8); max-width: 1600px; margin: 0 auto;">
    <!-- Page Header -->
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-6); flex-wrap: wrap; gap: var(--space-4);">
        <div>
            <h1 style="margin-bottom: var(--space-2);">{{ header_title }}</h1>
            <p class="text-secondary">Manage {{ item_name|lower }}s in the system</p>
        </div>
        {% if not from_dashboard %}
        {% if item_name == "Room" and current_floor %}
        <button id="bulkCreateBtn" class="btn btn-success btn-lg">
            <i class="fas fa-plus-circle"></i>
            <span>Add Rooms</span>
        </button>
        {% elif item_name != "Room" %}
        <button id="addBtn" class="btn btn-primary btn-lg">
            <i class="fas fa-plus-circle"></i>
            <span>Add {{ item_name }}</span>
        </button>
        {% endif %}
        {% endif %}
    </div>

    <!-- Table Card -->
    <div class="card card-elevated">
        <div class="card-body" style="padding: 0; overflow-x: auto;">
            <table id="itemList" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: var(--bg-secondary); border-bottom: 2px solid var(--border-primary);">
                        <th style="padding: var(--space-4); text-align: left; font-weight: var(--weight-semibold); color: var(--text-primary); white-space: nowrap;">Sr No.</th>
                        {% for field in form_fields %}
                        {% if field.table_display %}
                        <th style="padding: var(--space-4); text-align: left; font-weight: var(--weight-semibold); color: var(--text-primary); white-space: nowrap;">{{ field.label }}</th>
                        {% endif %}
                        {% endfor %}
                        {% if not from_dashboard %}
                        <th style="padding: var(--space-4); text-align: left; font-weight: var(--weight-semibold); color: var(--text-primary); white-space: nowrap;">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Items will be injected by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="addModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 600px; box-shadow: var(--shadow-2xl);">
        <div style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0; position: relative;">
            <span id="addClose" onclick="closeAddModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; opacity: 0.8; transition: opacity var(--transition-fast);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                &times;
            </span>
            <h2 style="margin: 0; color: white; font-size: var(--text-2xl);">Add New {{ item_name }}</h2>
        </div>
        <div style="padding: var(--space-8);">
            <form id="addForm">
                {% for field in form_fields %}
                {% if field.form_display %}
                <div class="form-group">
                    <label class="form-label" for="{{ field.name }}">{{ field.label }}</label>
                    {% if field.type == "select" %}
                    <select id="{{ field.name }}" name="{{ field.name }}" class="form-select" required>
                        {% for option in field.options %}
                        <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                    {% elif field.type == 'password' %}
                    <div style="position: relative;">
                        <input type="password" id="{{ field.name }}" name="{{ field.name }}" class="form-input" required style="padding-right: var(--space-12);">
                        <i class="fas fa-eye-slash password-toggle" id="toggle_{{ field.name }}" onclick="togglePassword('{{ field.name }}')" style="position: absolute; right: var(--space-4); top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-tertiary);"></i>
                    </div>
                    {% else %}
                    <input type="{{ field.type }}" id="{{ field.name }}" name="{{ field.name }}" class="form-input" {% if field.readonly %}readonly{% endif %} {% if field.maxlength %}maxlength="{{ field.maxlength }}"{% endif %} {% if field.pattern %}pattern="{{ field.pattern }}"{% endif %} {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %} required>
                    {% endif %}
                    {% if field.name == 'confirm_password' %}
                    <div id="password_error" style="display: none; background-color: var(--error-100); border: 1px solid var(--error-200); padding: var(--space-3); border-radius: var(--radius-md); color: var(--error-700); margin-top: var(--space-2); font-size: var(--text-sm);">
                        Passwords do not match, please re-enter.
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    <span>Create {{ item_name }}</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="editModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 600px; box-shadow: var(--shadow-2xl);">
        <div style="background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0; position: relative;">
            <span id="editClose" onclick="closeEditModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; opacity: 0.8; transition: opacity var(--transition-fast);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                &times;
            </span>
            <h2 style="margin: 0; color: white; font-size: var(--text-2xl);">Edit {{ item_name }}</h2>
        </div>
        <div style="padding: var(--space-8);">
            <form id="editForm">
                <input type="hidden" id="editItemId" name="itemId">
                {% for field in form_fields %}
                {% if field.form_display %}
                <div class="form-group">
                    <label class="form-label" for="edit_{{ field.name }}">{{ field.label }}</label>
                    {% if field.type == "select" %}
                    <select id="edit_{{ field.name }}" name="{{ field.name }}" class="form-select" required>
                        {% for option in field.options %}
                        <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                    {% elif field.type == 'password' %}
                    <div style="position: relative;">
                        <input type="password" id="edit_{{ field.name }}" name="{{ field.name }}" class="form-input" required style="padding-right: var(--space-12);">
                        <i class="fas fa-eye-slash password-toggle" id="toggle_edit_{{ field.name }}" onclick="togglePassword('edit_{{ field.name }}')" style="position: absolute; right: var(--space-4); top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-tertiary);"></i>
                    </div>
                    {% else %}
                    <input type="{{ field.type }}" id="edit_{{ field.name }}" name="{{ field.name }}" class="form-input" {% if field.readonly %}readonly{% endif %} {% if field.maxlength %}maxlength="{{ field.maxlength }}"{% endif %} {% if field.pattern %}pattern="{{ field.pattern }}"{% endif %} {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %} required>
                    {% endif %}
                    {% if field.name == 'confirm_password' %}
                    <div id="edit_password_error" style="display: none; background-color: var(--error-100); border: 1px solid var(--error-200); padding: var(--space-3); border-radius: var(--radius-md); color: var(--error-700); margin-top: var(--space-2); font-size: var(--text-sm);">
                        Passwords do not match, please re-enter.
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
                <button type="submit" class="btn btn-success btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    <span>Update {{ item_name }}</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
    <div style="background-color: var(--bg-elevated); margin: 15% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 500px; box-shadow: var(--shadow-2xl);">
        <div style="background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0;">
            <h2 style="margin: 0; color: white; font-size: var(--text-2xl);">Confirm Deletion</h2>
        </div>
        <div style="padding: var(--space-8);">
            <p style="color: var(--text-primary); margin-bottom: var(--space-6);">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div style="display: flex; gap: var(--space-3);">
                <button id="cancelDelete" class="btn btn-secondary btn-lg" onclick="closeDeleteModal()" style="flex: 1;">
                    <span>Cancel</span>
                </button>
                <button id="confirmDelete" class="btn btn-danger btn-lg" style="flex: 1;">
                    <i class="fas fa-trash"></i>
                    <span>Delete</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scheduled Classes Warning Modal -->
<div id="scheduledClassesModal" style="display: none; position: fixed; z-index: calc(var(--z-modal) + 10); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 700px; box-shadow: var(--shadow-2xl);">
        <div style="background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0; position: relative;">
            <span onclick="closeScheduledClassesModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; opacity: 0.8; transition: opacity var(--transition-fast);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                &times;
            </span>
            <h2 style="margin: 0; color: white; font-size: var(--text-2xl);"><i class="fas fa-exclamation-triangle"></i> Cannot Modify Room</h2>
        </div>
        <div style="padding: var(--space-8);">
            <div style="background-color: var(--warning-100); border: 1px solid var(--warning-300); padding: var(--space-5); border-radius: var(--radius-lg); margin-bottom: var(--space-6);">
                <p id="scheduledClassesMessage" style="color: var(--warning-800); font-weight: var(--weight-semibold); margin: 0;"></p>
            </div>

            <h3 style="color: var(--text-primary); margin-bottom: var(--space-4); font-size: var(--text-lg);">Scheduled Classes:</h3>
            <div id="scheduledClassesList" style="max-height: 400px; overflow-y: auto;">
                <!-- Class cards will be inserted here -->
            </div>

            <div style="background-color: var(--info-100); border: 1px solid var(--info-300); padding: var(--space-4); border-radius: var(--radius-md); margin-top: var(--space-6);">
                <p style="color: var(--info-800); margin: 0; font-size: var(--text-sm);">
                    <i class="fas fa-info-circle"></i> <strong>Action Required:</strong> Please reschedule or delete all classes from this room before marking it as unavailable or deleting it.
                </p>
            </div>

            <button onclick="closeScheduledClassesModal()" class="btn btn-primary btn-lg" style="width: 100%; margin-top: var(--space-6);">
                <span>Understood</span>
            </button>
        </div>
    </div>
</div>

<style>
    /* Table Styles */
    #itemList tbody tr {
        border-bottom: 1px solid var(--border-primary);
        transition: background-color var(--transition-fast);
    }

    #itemList tbody tr:hover {
        background-color: var(--bg-secondary);
    }

    #itemList tbody td {
        padding: var(--space-4);
        color: var(--text-primary);
        vertical-align: middle;
    }

    /* Type dropdown styles */
    .type-dropdown {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--weight-semibold);
        border: 2px solid;
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 100px;
        text-align: center;
        display: inline-block;
    }

    .type-dropdown.type-lab {
        background-color: var(--info-100);
        border-color: var(--info-300);
        color: var(--info-700);
    }

    .type-dropdown.type-lecture {
        background-color: var(--primary-100);
        border-color: var(--primary-300);
        color: var(--primary-700);
    }

    .type-dropdown.type-classroom {
        background-color: var(--success-100);
        border-color: var(--success-300);
        color: var(--success-700);
    }

    .type-dropdown:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    /* Availability dropdown */
    .availability-dropdown {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--weight-semibold);
        border: 2px solid;
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 100px;
        text-align: center;
        display: inline-block;
    }

    .availability-dropdown.available {
        background-color: var(--success-100);
        border-color: var(--success-300);
        color: var(--success-700);
    }

    .availability-dropdown.unavailable {
        background-color: var(--error-100);
        border-color: var(--error-300);
        color: var(--error-700);
    }

    .availability-dropdown:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    /* Action buttons in table */
    .action-btn {
        padding: var(--space-2) var(--space-3);
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        transition: all var(--transition-fast);
        margin-right: var(--space-2);
    }

    .action-btn-edit {
        background-color: var(--info-100);
        color: var(--info-700);
        border: 1px solid var(--info-200);
    }

    .action-btn-edit:hover {
        background-color: var(--info-200);
    }

    .action-btn-delete {
        background-color: var(--error-100);
        color: var(--error-700);
        border: 1px solid var(--error-200);
    }

    .action-btn-delete:hover {
        background-color: var(--error-200);
    }

    /* Loading Spinner */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-primary);
        border-top-color: var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        #itemList {
            font-size: var(--text-sm);
        }

        #itemList th,
        #itemList td {
            padding: var(--space-3);
        }
    }
</style>

<script>
    function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function closeScheduledClassesModal() {
        document.getElementById('scheduledClassesModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function togglePassword(fieldName) {
        const input = document.getElementById(fieldName);
        const toggle = document.getElementById('toggle_' + fieldName);

        if (input.type === 'password') {
            input.type = 'text';
            toggle.classList.remove('fa-eye-slash');
            toggle.classList.add('fa-eye');
        } else {
            input.type = 'password';
            toggle.classList.remove('fa-eye');
            toggle.classList.add('fa-eye-slash');
        }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const addModal = document.getElementById('addModal');
        const editModal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteConfirmModal');

        if (event.target == addModal) {
            closeAddModal();
        } else if (event.target == editModal) {
            closeEditModal();
        } else if (event.target == deleteModal) {
            closeDeleteModal();
        }
    };

    // Close modals on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAddModal();
            closeEditModal();
            closeDeleteModal();
            closeScheduledClassesModal();
        }
    });
</script>

<!-- JavaScript Configuration -->
<script>
    // Configuration for management page - rendered by Jinja
    const MANAGEMENT_CONFIG = {
        addUrl: "{{ add_url }}",
        getUrl: "{{ get_url }}",
        itemName: "{{ item_name | lower }}",
        formFields: {{ form_fields | tojson }},
        fromDashboard: {{ from_dashboard | tojson }},
        currentFloor: {{ current_floor | default('null') }}
    };
</script>

<!-- Include the management JavaScript -->
<script src="{{ url_for('static', filename='js/management.js') }}"></script>

{% if item_name == "Room" and current_floor %}
<!-- Add Rooms Modal -->
<div id="bulkModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-xl); width: 90%; max-width: 600px; box-shadow: var(--shadow-2xl);">
        <div style="background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%); padding: var(--space-6) var(--space-8); border-radius: var(--radius-xl) var(--radius-xl) 0 0; position: relative;">
            <span id="bulkClose" onclick="closeBulkModal()" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); font-weight: var(--weight-bold); cursor: pointer; opacity: 0.8; transition: opacity var(--transition-fast);" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">
                &times;
            </span>
            <h2 style="margin: 0; color: white; font-size: var(--text-2xl);">Add Rooms to Floor {{ current_floor }}</h2>
        </div>
        <div style="padding: var(--space-8);">
            <form id="bulkCreateForm">
                <div class="form-group">
                    <label class="form-label" for="rooms_per_floor">Number of Rooms *</label>
                    <input type="number" id="rooms_per_floor" name="rooms_per_floor" class="form-input"
                           min="1" required placeholder="e.g., 10">
                    <div class="form-help">
                        Rooms will be numbered sequentially from where they left off
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="room_type">Room Type *</label>
                    <select id="room_type" name="type" class="form-select" required>
                        <option value="">-- Select Type --</option>
                        <option value="Lab">Lab</option>
                        <option value="Lecture Hall">Lecture Hall</option>
                    </select>
                </div>

                <div id="bulkErrorMessage" style="display: none; background-color: var(--error-100); border: 1px solid var(--error-200); padding: var(--space-4); border-radius: var(--radius-md); color: var(--error-700); margin-bottom: var(--space-4);"></div>

                <button type="submit" class="btn btn-success btn-lg" style="width: 100%;">
                    <i class="fas fa-plus-circle"></i>
                    <span>Add Rooms</span>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function closeBulkModal() {
        document.getElementById('bulkModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
</script>
{% endif %}

{% endblock %}
