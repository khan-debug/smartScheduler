{% extends "layouts/base.html" %}

{% block title %}{{ header_title }}{% endblock %}

{% block top_bar %}{% endblock %}

{% block content %}
{% if show_back_button %}
<button class="back-button" onclick="window.location.href='{{ back_url }}'">&#8592;</button>
{% else %}
<button class="back-button" onclick="history.back()">&#8592;</button>
{% endif %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1>{{ header_title }}</h1>
    {% if not from_dashboard %}
    <button id="addBtn" class="btn-success">Add {{ item_name }}</button>
    {% endif %}
</div>

<table id="itemList" class="user-list-table">
    <thead>
        <tr>
            <th>Sr No.</th>
            {% for field in form_fields %}
            {% if field.table_display %}
            <th>{{ field.label }}</th>
            {% endif %}
            {% endfor %}
            {% if not from_dashboard %}
            <th>Actions</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        <!-- Items will be injected by JavaScript -->
    </tbody>
</table>

<!-- Add Item Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New {{ item_name }}</h2>
            <span class="close" id="addClose">&times;</span>
        </div>
        <form id="addForm">
            {% for field in form_fields %}
            {% if field.form_display %}
            <div class="form-group">
                <label for="{{ field.name }}">{{ field.label }}</label>
                {% if field.type == "select" %}
                <select id="{{ field.name }}" name="{{ field.name }}" required>
                    {% for option in field.options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
                {% elif field.type == 'password' %}
                <div class="password-input-wrapper">
                    <input type="password" id="{{ field.name }}" name="{{ field.name }}" required>
                    <i class="fas fa-eye-slash password-toggle" id="toggle_{{ field.name }}"></i>
                </div>
                {% else %}
                <input type="{{ field.type }}" id="{{ field.name }}" name="{{ field.name }}" {% if field.readonly %}readonly{% endif %} {% if field.maxlength %}maxlength="{{ field.maxlength }}"{% endif %} {% if field.pattern %}pattern="{{ field.pattern }}"{% endif %} {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %} required>
                {% endif %}
                {% if field.name == 'confirm_password' %}
                <div class="error-message" id="password_error" style="color: red; display: none;">Passwords do not match, please re-enter.</div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            <button type="submit" class="btn-submit">Create {{ item_name }}</button>
        </form>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit {{ item_name }}</h2>
            <span class="close" id="editClose">&times;</span>
        </div>
        <form id="editForm">
            <input type="hidden" id="editItemId" name="itemId">
            {% for field in form_fields %}
            {% if field.form_display %}
            <div class="form-group">
                <label for="edit_{{ field.name }}">{{ field.label }}</label>
                {% if field.type == "select" %}
                <select id="edit_{{ field.name }}" name="{{ field.name }}" required>
                    {% for option in field.options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
                {% elif field.type == 'password' %}
                <div class="password-input-wrapper">
                    <input type="password" id="edit_{{ field.name }}" name="{{ field.name }}" required>
                    <i class="fas fa-eye-slash password-toggle" id="toggle_edit_{{ field.name }}"></i>
                </div>
                {% else %}
                <input type="{{ field.type }}" id="edit_{{ field.name }}" name="{{ field.name }}" {% if field.readonly %}readonly{% endif %} {% if field.maxlength %}maxlength="{{ field.maxlength }}"{% endif %} {% if field.pattern %}pattern="{{ field.pattern }}"{% endif %} {% if field.placeholder %}placeholder="{{ field.placeholder }}"{% endif %} required>
                {% endif %}
                {% if field.name == 'confirm_password' %}
                <div class="error-message" id="edit_password_error" style="color: red; display: none;">Passwords do not match, please re-enter.</div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            <button type="submit" class="btn-submit">Update {{ item_name }}</button>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
        </div>
        <p>Are you sure you want to delete this item?</p>
        <div class="modal-buttons">
            <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
            <button id="confirmDelete" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<script>
    // Configuration for management page - rendered by Jinja
    const MANAGEMENT_CONFIG = {
        addUrl: "{{ add_url }}",
        getUrl: "{{ get_url }}",
        itemName: "{{ item_name | lower }}",
        formFields: {{ form_fields | tojson }},
        fromDashboard: {{ from_dashboard | tojson }}
    };
</script>
<script src="{{ url_for('static', filename='js/management.js') }}"></script>
{% endblock %}