{% extends "layouts/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% if hide_top_bar %}
{% block top_bar %}{% endblock %}
{% endif %}

{% block content %}

{% if show_back_button %}
<button class="back-button" onclick="history.back()">&#8592;</button>
{% endif %}

{% if show_teacher_header %}
<div class="header-container">
    <div class="teacher-profile-header">
        <div class="teacher-info">
            <h1 class="teacher-name">Timetable</h1>
        </div>
    </div>
    <div class="username-display">
        Welcome, {{ username }}!
    </div>
</div>
{% endif %}

{% if show_page_title %}
<h1 class="mb-20">{{ page_title_text }}</h1>
{% endif %}

<div class="timetable-container">
    <table class="timetable" id="timetableTable">
        <thead>
            <tr>
                <th class="time-col">Time</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
                <th>Saturday</th>
                <th>Sunday</th>
            </tr>
        </thead>
        <tbody id="timetableBody">
            {% for hour in range(8, 23) %}
            <tr data-hour="{{ hour }}">
                <td class="time-col">{{ '%02d:00' % hour }}</td>
                <td data-day="Monday"></td>
                <td data-day="Tuesday"></td>
                <td data-day="Wednesday"></td>
                <td data-day="Thursday"></td>
                <td data-day="Friday"></td>
                <td data-day="Saturday"></td>
                <td data-day="Sunday"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Class Details Modal (for floor view) -->
<div id="classDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 id="modalTitle">Scheduled Classes</h2>
            <span class="close" id="closeClassModal">&times;</span>
        </div>
        <div class="modal-body" id="classDetailsBody">
            <!-- Class details will be inserted here -->
        </div>
    </div>
</div>

<style>
    .class-count-badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 50%;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 40px;
        min-height: 40px;
        line-height: 24px;
        text-align: center;
    }

    .class-count-badge:hover {
        transform: scale(1.15);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .class-details-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .class-item {
        padding: 20px;
        background-color: var(--card-bg);
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .class-item:hover {
        border-color: var(--accent-blue);
        transform: translateX(5px);
    }

    .class-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .class-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .class-detail-row {
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .class-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .class-detail-item i {
        color: var(--accent-blue);
    }

    .class-detail-item strong {
        color: var(--text-primary);
    }

    .modal-body {
        padding: 25px;
        max-height: 70vh;
        overflow-y: auto;
    }
</style>

<script>
    const roomFilter = {{ room_filter|tojson }};
    const teacherFilter = {{ teacher_filter|tojson }};
    const floorFilter = {{ floor_filter|tojson }};

    window.onload = function() {
        if (floorFilter) {
            // Load floor timetable (aggregate view)
            loadFloorTimetable(floorFilter);
        } else if (roomFilter || teacherFilter) {
            // Load specific room/teacher timetable
            loadFilteredTimetable(roomFilter, teacherFilter);
        }
    };

    function loadFloorTimetable(floor) {
        // Load aggregate view for floor - shows count of classes
        fetch(`/get_scheduled_classes?floor=${floor}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayFloorAggregate(data.classes);
                } else {
                    console.error('Error loading floor timetable:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading floor timetable:', error);
            });
    }

    function loadFilteredTimetable(room, teacher) {
        // Load timetable filtered by room and/or teacher
        let url = '/get_scheduled_classes?';
        const params = [];
        if (room) params.push(`room=${encodeURIComponent(room)}`);
        if (teacher) params.push(`teacher=${encodeURIComponent(teacher)}`);
        url += params.join('&');

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTimetable(data.classes);
                } else {
                    console.error('Error loading timetable:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading timetable:', error);
            });
    }

    function displayTimetable(classes) {
        // Display classes in timetable cells (for room/teacher view)
        classes.forEach(cls => {
            const startHour = parseInt(cls.start_time.split(':')[0]);
            const cell = document.querySelector(`tr[data-hour="${startHour}"] td[data-day="${cls.day}"]`);

            if (cell) {
                cell.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 8px;
                                border-radius: 6px;
                                font-size: 0.85rem;
                                cursor: pointer;"
                         onclick='showClassInfo(${JSON.stringify(cls)})'>
                        <div style="font-weight: 600; margin-bottom: 4px;">${cls.course_name}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${cls.section_code}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9;">${cls.room_number}</div>
                    </div>
                `;
            }
        });
    }

    function displayFloorAggregate(classes) {
        // Group classes by day and hour
        const grouped = {};

        classes.forEach(cls => {
            const startHour = parseInt(cls.start_time.split(':')[0]);
            const key = `${cls.day}-${startHour}`;

            if (!grouped[key]) {
                grouped[key] = [];
            }
            grouped[key].push(cls);
        });

        // Display count badges
        Object.keys(grouped).forEach(key => {
            const [day, hour] = key.split('-');
            const cell = document.querySelector(`tr[data-hour="${hour}"] td[data-day="${day}"]`);
            const classList = grouped[key];

            if (cell) {
                cell.innerHTML = `
                    <span class="class-count-badge" onclick='showClassDetails("${day}", ${hour}, ${classList.length}, ${JSON.stringify(classList)})'>
                        ${classList.length}
                    </span>
                `;
            }
        });
    }

    function showClassInfo(cls) {
        // Show individual class info modal
        const modal = document.getElementById('classDetailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('classDetailsBody');

        modalTitle.textContent = `${cls.course_name} - ${cls.section_code}`;

        modalBody.innerHTML = `
            <div class="class-item">
                <div class="class-detail-row">
                    <div class="class-detail-item">
                        <i class="fas fa-door-open"></i>
                        <span>Room: <strong>${cls.room_number}</strong></span>
                    </div>
                    <div class="class-detail-item">
                        <i class="fas fa-user-tie"></i>
                        <span>Teacher: <strong>${cls.teacher_name}</strong></span>
                    </div>
                    <div class="class-detail-item">
                        <i class="fas fa-book"></i>
                        <span>Type: <strong>${cls.course_type}</strong></span>
                    </div>
                    <div class="class-detail-item">
                        <i class="fas fa-clock"></i>
                        <span>Time: <strong>${cls.start_time} - ${cls.end_time}</strong></span>
                    </div>
                    <div class="class-detail-item">
                        <i class="fas fa-calendar-day"></i>
                        <span>Day: <strong>${cls.day}</strong></span>
                    </div>
                    <div class="class-detail-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Credit: <strong>${cls.credit_hour}h</strong></span>
                    </div>
                </div>
            </div>
        `;

        modal.style.display = 'block';
    }

    function showClassDetails(day, hour, classCount, classes) {
        const modal = document.getElementById('classDetailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('classDetailsBody');

        modalTitle.textContent = `${classCount} Class${classCount !== 1 ? 'es' : ''} Scheduled - ${day} at ${hour}:00`;

        let html = '<ul class="class-details-list">';

        classes.forEach(cls => {
            html += `
                <li class="class-item">
                    <div class="class-item-header">
                        <span class="class-name">${cls.course_name}</span>
                        <span class="badge" style="background-color: var(--accent-blue); padding: 5px 12px; border-radius: 12px; font-size: 0.85rem;">
                            ${cls.section_code}
                        </span>
                    </div>
                    <div class="class-detail-row">
                        <div class="class-detail-item">
                            <i class="fas fa-door-open"></i>
                            <span>Room: <strong>${cls.room}</strong></span>
                        </div>
                        <div class="class-detail-item">
                            <i class="fas fa-user-tie"></i>
                            <span>Teacher: <strong>${cls.teacher}</strong></span>
                        </div>
                        <div class="class-detail-item">
                            <i class="fas fa-book"></i>
                            <span>Type: <strong>${cls.course_type}</strong></span>
                        </div>
                        <div class="class-detail-item">
                            <i class="fas fa-clock"></i>
                            <span>Credit: <strong>${cls.credit_hour}h</strong></span>
                        </div>
                    </div>
                </li>
            `;
        });

        html += '</ul>';
        modalBody.innerHTML = html;

        modal.style.display = 'block';
    }

    // Modal close handlers
    document.getElementById('closeClassModal').onclick = function() {
        document.getElementById('classDetailsModal').style.display = 'none';
    };

    window.onclick = function(event) {
        const modal = document.getElementById('classDetailsModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    };
</script>

{% endblock %}
