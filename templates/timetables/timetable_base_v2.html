{% extends "layouts/base_v2.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div style="padding: var(--space-6); max-width: 100%; margin: 0 auto;">
    {% if show_teacher_header %}
    <!-- Teacher Header -->
    <div class="card card-elevated" style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); border: none; margin-bottom: var(--space-6);">
        <div class="card-body" style="padding: var(--space-6);">
            <h1 style="color: white; margin-bottom: var(--space-2); font-size: var(--text-2xl);">My Timetable</h1>
            <p style="color: rgba(255, 255, 255, 0.9); font-size: var(--text-base);">Welcome, {{ username }}!</p>
        </div>
    </div>
    {% endif %}

    {% if show_page_title %}
    <h1 style="margin-bottom: var(--space-6); font-size: var(--text-3xl); color: var(--text-primary);">{{ page_title_text }}</h1>
    {% endif %}

    <!-- Timetable Card -->
    <div class="card card-elevated">
        <div class="card-body" style="padding: 0; overflow: auto;">
            <div class="timetable-container">
                <table class="timetable" id="timetableTable">
                    <thead>
                        <tr>
                            <th class="time-col">Time</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                            <th>Saturday</th>
                            <th>Sunday</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                        {% for hour in range(8, 23) %}
                        <tr data-hour="{{ hour }}">
                            <td class="time-col">{{ '%02d:00' % hour }}</td>
                            <td data-day="Monday"></td>
                            <td data-day="Tuesday"></td>
                            <td data-day="Wednesday"></td>
                            <td data-day="Thursday"></td>
                            <td data-day="Friday"></td>
                            <td data-day="Saturday"></td>
                            <td data-day="Sunday"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Overlay container for precisely positioned classes -->
                <div class="timetable-overlay" id="timetableOverlay"></div>
            </div>
        </div>
    </div>
</div>

<!-- Class Details Modal -->
<div id="classDetailsModal" style="display: none; position: fixed; z-index: var(--z-modal); left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); overflow: auto;">
    <div style="background-color: var(--bg-elevated); margin: 5% auto; padding: 0; border: 1px solid var(--border-primary); border-radius: var(--radius-2xl); max-width: 700px; width: 90%; box-shadow: var(--shadow-2xl);">
        <div style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%); padding: var(--space-6); border-radius: var(--radius-2xl) var(--radius-2xl) 0 0; position: relative;">
            <h2 id="modalTitle" style="margin: 0; color: white; font-size: var(--text-xl);">Scheduled Classes</h2>
            <span id="closeClassModal" style="position: absolute; right: var(--space-6); top: var(--space-6); color: white; font-size: var(--text-2xl); cursor: pointer; width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                &times;
            </span>
        </div>
        <div id="classDetailsBody" style="padding: var(--space-6); max-height: 70vh; overflow-y: auto;">
            <!-- Class details will be inserted here -->
        </div>
    </div>
</div>

<style>
    /* Timetable Container */
    .timetable-container {
        position: relative;
        width: 100%;
        min-height: 500px;
    }

    /* Timetable Styles */
    .timetable {
        width: 100%;
        border-collapse: collapse;
        background-color: var(--bg-elevated);
        position: relative;
    }

    .timetable thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--bg-secondary);
    }

    .timetable th {
        padding: var(--space-4);
        text-align: center;
        font-weight: var(--weight-semibold);
        color: var(--text-primary);
        border: 1px solid var(--border-primary);
        background-color: var(--bg-secondary);
        font-size: var(--text-sm);
    }

    .timetable th.time-col {
        width: 100px;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        color: white;
    }

    .timetable td {
        height: 60px;
        border: 1px solid var(--border-primary);
        padding: var(--space-2);
        vertical-align: top;
        background-color: var(--bg-elevated);
        transition: background-color var(--transition-fast);
    }

    .timetable td:hover {
        background-color: var(--bg-secondary);
    }

    .timetable td.time-col {
        text-align: center;
        font-weight: var(--weight-semibold);
        color: var(--text-secondary);
        background-color: var(--bg-secondary);
        font-size: var(--text-sm);
    }

    /* Overlay for positioned classes */
    .timetable-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
    }

    /* Class Block Styles */
    .class-block {
        position: absolute;
        padding: var(--space-3);
        border-radius: var(--radius-md);
        border-left: 4px solid;
        cursor: pointer;
        pointer-events: auto;
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-fast);
        overflow: hidden;
    }

    .class-block:hover {
        transform: translateX(2px);
        box-shadow: var(--shadow-lg);
        z-index: 100 !important;
    }

    .class-block-header {
        font-weight: var(--weight-semibold);
        font-size: var(--text-sm);
        margin-bottom: var(--space-1);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .class-block-details {
        font-size: var(--text-xs);
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-0-5);
    }

    .class-block-time {
        font-size: var(--text-xs);
        opacity: 0.8;
        font-weight: var(--weight-medium);
    }

    /* Class Count Badge */
    .class-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--secondary-600) 100%);
        color: white;
        padding: var(--space-2);
        border-radius: 50%;
        font-size: var(--text-sm);
        font-weight: var(--weight-bold);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 36px;
        min-height: 36px;
        box-shadow: var(--shadow-md);
    }

    .class-count-badge:hover {
        transform: scale(1.15);
        box-shadow: var(--shadow-xl);
    }

    /* Modal Class List */
    .class-details-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: var(--space-4);
    }

    .class-item {
        padding: var(--space-5);
        background-color: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-primary);
        transition: all var(--transition-fast);
    }

    .class-item:hover {
        border-color: var(--primary-500);
        transform: translateX(5px);
        box-shadow: var(--shadow-md);
    }

    .class-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }

    .class-name {
        font-size: var(--text-lg);
        font-weight: var(--weight-semibold);
        color: var(--text-primary);
    }

    .class-detail-row {
        display: flex;
        gap: var(--space-6);
        flex-wrap: wrap;
        margin-top: var(--space-2);
    }

    .class-detail-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--text-secondary);
        font-size: var(--text-sm);
    }

    .class-detail-item i {
        color: var(--primary-500);
    }

    .class-detail-item strong {
        color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .timetable th,
        .timetable td {
            padding: var(--space-2);
            font-size: var(--text-xs);
        }

        .class-block {
            padding: var(--space-2);
        }

        .class-block-header {
            font-size: var(--text-xs);
        }

        .class-block-details,
        .class-block-time {
            font-size: 10px;
        }
    }
</style>

<script>
    const roomFilter = {{ room_filter|tojson }};
    const teacherFilter = {{ teacher_filter|tojson }};

    window.onload = function() {
        console.log('Filters:', { roomFilter, teacherFilter });

        if (roomFilter || teacherFilter) {
            console.log('Loading filtered timetable for room:', roomFilter, 'teacher:', teacherFilter);
            loadFilteredTimetable(roomFilter, teacherFilter);
        } else {
            console.log('No filters set');
        }
    };

    // ========== Time & Position Calculation ==========

    const TIME_CONSTANTS = {
        START_HOUR: 8,
        ROW_HEIGHT: 60,
        TIME_COL_WIDTH: 100
    };

    function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }

    function calculateTopPosition(timeStr, tableTop, headerHeight) {
        const timeMinutes = timeToMinutes(timeStr);
        const startMinutes = TIME_CONSTANTS.START_HOUR * 60;
        const minutesSinceStart = timeMinutes - startMinutes;
        const pixelsPerMinute = TIME_CONSTANTS.ROW_HEIGHT / 60;
        return tableTop + headerHeight + (minutesSinceStart * pixelsPerMinute);
    }

    function calculateClassHeight(startTime, endTime) {
        const durationMinutes = timeToMinutes(endTime) - timeToMinutes(startTime);
        const pixelsPerMinute = TIME_CONSTANTS.ROW_HEIGHT / 60;
        return durationMinutes * pixelsPerMinute;
    }

    function calculateDayPosition(day, tableLeft) {
        const dayCell = document.querySelector(`td[data-day="${day}"]`);
        if (!dayCell) return { left: 0, width: 0 };

        const container = document.querySelector('.timetable-container');
        const containerRect = container.getBoundingClientRect();
        const cellRect = dayCell.getBoundingClientRect();

        return {
            left: cellRect.left - containerRect.left,
            width: cellRect.width
        };
    }

    function getTableDimensions() {
        const table = document.getElementById('timetableTable');
        const tableRect = table.getBoundingClientRect();
        const container = document.querySelector('.timetable-container');
        const containerRect = container.getBoundingClientRect();
        const header = table.querySelector('thead tr');

        return {
            tableTop: tableRect.top - containerRect.top,
            tableLeft: tableRect.left - containerRect.left,
            headerHeight: header ? header.offsetHeight : 0
        };
    }

    // ========== Color Assignment ==========

    const COURSE_COLORS = [
        { bg: 'rgba(102, 126, 234, 0.15)', border: 'var(--primary-500)', text: 'var(--primary-700)' },
        { bg: 'rgba(76, 175, 80, 0.15)', border: 'var(--success-500)', text: 'var(--success-700)' },
        { bg: 'rgba(255, 152, 0, 0.15)', border: 'var(--warning-500)', text: 'var(--warning-700)' },
        { bg: 'rgba(156, 39, 176, 0.15)', border: '#9c27b0', text: '#7b1fa2' },
        { bg: 'rgba(0, 188, 212, 0.15)', border: '#00bcd4', text: '#0097a7' },
        { bg: 'rgba(244, 67, 54, 0.15)', border: 'var(--error-500)', text: 'var(--error-700)' },
        { bg: 'rgba(63, 81, 181, 0.15)', border: '#3f51b5', text: '#303f9f' },
        { bg: 'rgba(233, 30, 99, 0.15)', border: '#e91e63', text: '#c2185b' }
    ];

    const courseColorMap = new Map();
    let colorIndex = 0;

    function getCourseColor(courseName, sectionCode) {
        const key = `${courseName}_${sectionCode}`;
        if (!courseColorMap.has(key)) {
            courseColorMap.set(key, COURSE_COLORS[colorIndex % COURSE_COLORS.length]);
            colorIndex++;
        }
        return courseColorMap.get(key);
    }

    // ========== Timetable Rendering ==========

    function loadFilteredTimetable(roomNumber, teacherReg) {
        let endpoint = '/get_scheduled_classes?';
        if (roomNumber) endpoint += `room=${encodeURIComponent(roomNumber)}`;
        if (teacherReg) {
            if (roomNumber) endpoint += '&';
            endpoint += `teacher=${encodeURIComponent(teacherReg)}`;
        }

        console.log('Fetching from endpoint:', endpoint);

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                if (data.success) {
                    console.log('Number of classes:', data.classes.length);
                    renderTimetableClasses(data.classes);
                } else {
                    console.error('Error loading timetable:', data.error);
                }
            })
            .catch(error => console.error('Error fetching timetable:', error));
    }


    function renderTimetableClasses(classes) {
        console.log('Rendering timetable classes:', classes);
        const overlay = document.getElementById('timetableOverlay');
        overlay.innerHTML = '';

        if (!classes || classes.length === 0) {
            console.log('No classes to render');
            overlay.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-secondary);"><i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px;"></i><p>No scheduled classes found for the selected filter</p></div>';
            return;
        }

        const dimensions = getTableDimensions();
        console.log('Table dimensions:', dimensions);

        let renderedCount = 0;
        classes.forEach(cls => {
            console.log('Processing class:', cls);
            const dayPos = calculateDayPosition(cls.day, dimensions.tableLeft);
            console.log('Day position for', cls.day, ':', dayPos);

            if (dayPos.width === 0) {
                console.log('Skipping class - day position width is 0');
                return;
            }

            const top = calculateTopPosition(cls.start_time, dimensions.tableTop, dimensions.headerHeight);
            const height = calculateClassHeight(cls.start_time, cls.end_time);
            const color = getCourseColor(cls.course_name, cls.section_code);

            console.log('Class position:', { top, height, left: dayPos.left, width: dayPos.width });

            const classDiv = document.createElement('div');
            classDiv.className = 'class-block';
            classDiv.style.cssText = `
                left: ${dayPos.left}px;
                top: ${top}px;
                width: ${dayPos.width}px;
                height: ${height}px;
                background-color: ${color.bg};
                border-left-color: ${color.border};
                color: ${color.text};
            `;

            classDiv.innerHTML = `
                <div class="class-block-header">${cls.course_name}</div>
                <div class="class-block-details">
                    <i class="fas fa-tag"></i> ${cls.section_code}
                </div>
                <div class="class-block-details">
                    <i class="fas fa-door-open"></i> Room ${cls.room_number}
                </div>
                <div class="class-block-time">
                    <i class="fas fa-clock"></i> ${cls.start_time} - ${cls.end_time}
                </div>
            `;

            overlay.appendChild(classDiv);
            renderedCount++;
        });

        console.log('Rendered', renderedCount, 'classes');
    }


    // Modal Controls
    document.getElementById('closeClassModal').onclick = () => {
        document.getElementById('classDetailsModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    };

    window.onclick = (e) => {
        const modal = document.getElementById('classDetailsModal');
        if (e.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    };

    // Recalculate positions on window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (roomFilter || teacherFilter) {
                loadFilteredTimetable(roomFilter, teacherFilter);
            }
        }, 250);
    });
</script>
{% endblock %}
